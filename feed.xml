<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://sunetrike.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://sunetrike.com/" rel="alternate" type="text/html" /><updated>2024-11-30T14:58:59+08:00</updated><id>https://sunetrike.com/feed.xml</id><title type="html">sunE</title><subtitle>Wake up to the world that solar and Low Speed Electric Vehicles (LSEVs) can offer the Philippines</subtitle><author><name>Allan Gray</name></author><entry><title type="html">sunE featured in One ASEAN Start-up White Paper on Innovation Ecosystem development!</title><link href="https://sunetrike.com/smart-cities/sunE-in-ERIAs-ASEAN-startup-ecosystem-whitepaper/" rel="alternate" type="text/html" title="sunE featured in One ASEAN Start-up White Paper on Innovation Ecosystem development!" /><published>2024-10-18T01:08:07+08:00</published><updated>2024-10-18T01:08:07+08:00</updated><id>https://sunetrike.com/smart-cities/sunE-in-ERIAs-ASEAN-startup-ecosystem-whitepaper</id><content type="html" xml:base="https://sunetrike.com/smart-cities/sunE-in-ERIAs-ASEAN-startup-ecosystem-whitepaper/"><![CDATA[<p>ERIA reached out to us earlier this year with interest in our experience, as a start-up, operating across borders (Philippines and Hong Kong).  We were glad to participate and would be glad to see more companies across the region take this step.</p>

<p>We also look forward to seeing how they move forward with their findings from section 3.3 - Impact Investing.</p>

<p>Their whitepaper is now posted, you can also view their <a href="https://www.eria.org/news-and-views/eria-launches-one-asean-start-up-white-paper-on-southeast-asia-s-innovation-ecosystem-at-asean-business-and-investment-summit-2024">press release of the report</a></p>

<p>sunE is mentioned briefly at p28:</p>

<object data="/assets/pdfs/ERIA-One-ASEAN-Start-up-White-Paper-2024.pdf" width="600" height="400" type="application/pdf">
  <p>It appears as though your browser doesn't have a PDF plugin.

  	<h3>It is available for Download here:</h3> 
  	<a href="/assets/pdfs/ERIA-One-ASEAN-Start-up-White-Paper-2024.pdf">Towards an ASEAN Innovation Ecosystem: Start-up Creation for Inclusive and Sustainable Economic Development</a>
  </p>
</object>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="smart-cities" /><summary type="html"><![CDATA[ERIA reached out to us earlier this year with interest in our experience, as a start-up, operating across borders (Philippines and Hong Kong). We were glad to participate and would be glad to see more companies across the region take this step.]]></summary></entry><entry><title type="html">sunE sits down with the Sustainability/Smart Cities Podcast!</title><link href="https://sunetrike.com/smart-cities/transportation/sune-on-the-smart-cities-podcast/" rel="alternate" type="text/html" title="sunE sits down with the Sustainability/Smart Cities Podcast!" /><published>2023-01-24T01:08:07+08:00</published><updated>2023-01-24T01:08:07+08:00</updated><id>https://sunetrike.com/smart-cities/transportation/sune-on-the-smart-cities-podcast</id><content type="html" xml:base="https://sunetrike.com/smart-cities/transportation/sune-on-the-smart-cities-podcast/"><![CDATA[<p>Allan Gray was given the chance to chat with Jim Frazier on the Sustainbaility (FKA Smart Cities) podcast about sunE and our work in the Filipino public transportation sector. Check it out below!</p>

<div id="buzzsprout-player-12076983"></div>
<script src="https://www.buzzsprout.com/582526/12076983-solar-powered-three-wheeled-trikes-for-the-philippines-a-conversation-with-allan-gray-of-sunetrike.js?container_id=buzzsprout-player-12076983&amp;player=small" type="text/javascript" charset="utf-8"></script>

<p><a href="https://thesustainabilitypodcast.buzzsprout.com/">You can also check out the other episodes from the podcast here</a></p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="smart-cities" /><category term="transportation" /><summary type="html"><![CDATA[Allan Gray was given the chance to chat with Jim Frazier on the Sustainbaility (FKA Smart Cities) podcast about sunE and our work in the Filipino public transportation sector. Check it out below!]]></summary></entry><entry><title type="html">Press Release - International Research Collaboration for energy harvesting vehicle suspension</title><link href="https://sunetrike.com/energy-harvester/announcements/sune-energy-harvester-research-grant/" rel="alternate" type="text/html" title="Press Release - International Research Collaboration for energy harvesting vehicle suspension" /><published>2021-11-24T01:08:07+08:00</published><updated>2021-11-24T01:08:07+08:00</updated><id>https://sunetrike.com/energy-harvester/announcements/sune-energy-harvester-research-grant</id><content type="html" xml:base="https://sunetrike.com/energy-harvester/announcements/sune-energy-harvester-research-grant/"><![CDATA[<p>sunE is pleased to announce the undertaking of a new international research collaboration around energy harvesting suspencsion systems for low-speed electric vehicles.</p>

<object data="/assets/pdfs/2021-11-24_harvester-pr.pdf" width="600" height="400" type="application/pdf">
  <p>It appears as though your browser doesn't have a PDF plugin.

  	<h3>It is available for Download here:</h3> 
  	<a href="/assets/pdfs/2021-11-24_harvester-pr.pdf">Nov 2021 Energy Harvester project press release</a>
  </p>
</object>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="energy-harvester" /><category term="announcements" /><summary type="html"><![CDATA[sunE is pleased to announce the undertaking of a new international research collaboration around energy harvesting suspencsion systems for low-speed electric vehicles.]]></summary></entry><entry><title type="html">A TDD rake based build-system for multi-targeting Arm Cortex-M - using the teensy 3.6 as an example</title><link href="https://sunetrike.com/open-source/embedded/teensy/a-test-drive-build-system-for-teensy/" rel="alternate" type="text/html" title="A TDD rake based build-system for multi-targeting Arm Cortex-M - using the teensy 3.6 as an example" /><published>2021-10-22T01:08:07+08:00</published><updated>2021-10-22T01:08:07+08:00</updated><id>https://sunetrike.com/open-source/embedded/teensy/a-test-drive-build-system-for-teensy</id><content type="html" xml:base="https://sunetrike.com/open-source/embedded/teensy/a-test-drive-build-system-for-teensy/"><![CDATA[<p><strong>Learn how to create modular code for embedded systems using a Test Driven Development approach</strong></p>

<h2 id="intro-and-background">Intro and background</h2>

<p>Want to dig deeper into developing with Arm Cortex MCUs?  Interested in seeing how embedded systems are tested or developing some TDD skills for Arduino projects?  Have a go at this tutorial!</p>

<p>We at sunEtrike have big dreams for our software development.  While I did take one CompSci course during my first year of college/uni, beyond that I’ve had to learn everything else as I went.</p>

<p>One of the things I hated most about coding was tracking down bugs.  For us to one day grow into a professional software team, we have to have strong systems in place for catching bugs and ensuring quality.</p>

<p>Test Driven Development has gone up and down of favour over the years but I think by now it’s well understood in the industry understands that code needs to be well tested before it goes out to users.</p>

<p>An automated testing suite is a very important piece of that process, especially for devops oriented teams.
With this tutorial, I have finally managed to combine my learnings into a test suite that builds on a real board.</p>

<h2 id="what-are-you-getting-out-of-completing-this-tutorialexercise--a-modularized-tdd-example-of-blinky-using-minimalist-tools">What are you getting out of completing this tutorial/exercise?  A modularized TDD example of blinky using minimalist tools</h2>

<p>This article will build for the open source <a href="https://www.pjrc.com/store/teensy36.html">teensy3.6</a>.</p>

<p>Then in the follow on article we will add the <a href="https://www.nxp.com/part/FRDM-KL25Z">FRDM-KL25Z</a> a development board by NXG with lots of interesting peripherals included.  The FRDM SDK is more low level compared to the teensy so that one will be shorter but more technical.</p>

<p>This tutorial may be worthwhile for you to try if:</p>

<ol>
  <li>
    <p>You are an Arduino developer who hasn’t yet built an app outside of a single file Arduino sketch and are interested in upping your coding skills and learning how to use TDD to make your code more modular and portable.</p>
  </li>
  <li>
    <p>You are a TDD-inclined Ruby developer interested in getting into embedded systems and IoT.</p>
  </li>
</ol>

<p>At the end of this tutorial, You will have a test driven version of the <code class="language-plaintext highlighter-rouge">blinky</code> module that often plays the role of <code class="language-plaintext highlighter-rouge">Hello World</code> for embedded systems/Arduino projects.</p>

<p>Basically, this article is my attempt to distill what I’ve learned about embedded testing to date and hopefully give a starting point to anybody who is interested in trying automated testing/Test Driven Development (TDD) within the world of open-source &amp; embedded systems.</p>

<p>You can browse the <a href="https://github.com/graial/teensy_rake">github repo</a> to have a look.  It is a <a href="https://github.com/ruby/rake">Rake</a> based build using <a href="https://www.throwtheswitch.org">Unity</a> as the testing framework.  After getting the toolchain set-up, we’ll use TDD to refactor teensy’s starter blinky code into its own module and add an abstraction layer to the interface.</p>

<p>This Rakefile was developed and tested using a Linux system and GCC11.  I am pretty rusty with Windows these days but I realize it’s still super common for embedded systems developer to use Windows so don’t worry if that’s you.  Here’s an NXP tutorial for setting up the <a href="https://www.nxp.com/document/guide/get-started-with-the-frdm-kl25z:NGS-FRDM-KL25Z#0">GCC toolchain on  Windows via MingW</a>. 
 Alternatively, if you dont have Linux on your CPU you can also try <a href="https://docs.microsoft.com/en-us/windows/wsl/install">Windows Subsystem Linux</a></p>

<h2 id="why-bother-with-automated-testing-for-embedded-systems">Why bother with automated testing for embedded systems?</h2>

<p>I’m a big fan of automated testing.  As somebody who is always juggling a lot of balls in the air.  It gives me a lot of comfort to revisit an area of my codebase that I haven’t seen in 6-8 months and allow the tests to remind me how it works.</p>

<h3 id="dual-targeting-and-even-multi-targeting">Dual-targeting and even multi-targeting</h3>

<p>There has been a lot of news lately about a global shortage in microcontrollers and semiconductors.  So the ability to write an embedded application that can build on multiple devices may mean the difference of whether or not your protoypes make it into production.  TDD forces you to decouple your application layer from the underlying hardware which, generally makes for better portability to other devices &amp; systems.</p>

<h3 id="solid-flexible-and-testable-designs">SOLID, Flexible, and Testable Designs</h3>

<p>The term ‘spaghetti code’ gets thrown around a lot in the software world.  Codebases that have long, complicated functions, nested ifs, etc can become a nightmare to tweak &amp; maintain over time.  As a codebase progresses and matures, these types of interwoven dependencies can significantly slow down progress and new releases.<br />
One of the main benefits of TDD is the way it forces you to think about the design and structures of your code.  Grenning identifies the SOLID framework, originally attributed to “Uncle” Bob Martin in <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/pfi.21408">“Agile Software Development: Principles, Patterns, and Practices”</a>.</p>

<p>The C-language is not object oriented which means that these principles are implemented at the module level.</p>

<p>There are plenty of articles on the internet which describe SOLID in different contexts so I’m only going to briefly describe how I understand these principles to apply to the embedded context.</p>

<ul>
  <li>
    <p><strong>S Single Responsibility Principle</strong> - The name says it all here; a module should have one job.  This often leads to very descriptive module names.  A module called <strong>LEDdriver.c</strong> is expected to turn the LEDs on and off.</p>
  </li>
  <li>
    <p><strong>O Open-Closed Principle</strong> - ‘Open for extension, Closed for modification’. For example, The LedDriver.c module may leverage a separate <strong>BaseLedDriver.c</strong> module in order to trigger the specific actions for the teensy.  If you now want to add support for a new device (Netduino, for example), You would create a <strong>NetduinoLedDriver.c</strong> which also calls <strong>BaseLedDriver</strong>. Both devices would then interact with the rest of the application in the same way even if their underlying implementations are different.  As a developer, you do not need to modify <strong>BaseLedDriver.c</strong> to add a new target board.  We will dig into this when we abstract our teensy code to handle a second device.</p>
  </li>
  <li>
    <p><strong>L Liskov Substitution Principle</strong> - In the LEDdriver example, you might create a data structure that encompasses the basic information of an LedDriver.  This is what permits you to substitute in a mock interface during testing.  By doing this, any other module (an <strong>LedScheduler.c</strong>, for example) that wants to trigger an Led, will use the same function call. The calling module does not care about the implemenation details.</p>
  </li>
  <li>
    <p><strong>I Interface Segregation Principle</strong> - The interface of a module should be limited to a single concept.  An <strong>LedDriver.c</strong> is basically a light-switch.  It wouldn’t make sense for you to check the time by looking at a light switch.  Time and Light “Status” are very different concepts.  If you find yourself asking about both of those concepts within the same interface, function call, etc) Then the interfae of your module is probably not well segregated.</p>
  </li>
  <li>
    <p><strong>D Dependency Inversion Principle</strong> - Dependencies between modules create problems both for testing and for changing over time.  It’s can be very challenging to debug embedded systems especially since the physical world can do something unexpected (up to and including cosmically-induced bit-flips) which suddenly place the device in <em>no man’s land</em> as far as your code is concerned.  While these issues will always challenge even the most battle-hardened software vets who are operating down near the bare-metal, the ability to reduce dependencies can help to simplify the problem of how to escape from an unknown state-space.<br />
Putting this into practice in testing will often involve turning your module into a ‘black-box’.  Where the caller makes an abstracted call such as <strong>‘is Led #5 on?’</strong> or <strong>‘turn the blue led off’</strong>.  The internal details of how the serving module makes that call is hidden from the caller.  In embedded TDD, function pointers are often used in order to allow testing of these abstracted interfaces.</p>
  </li>
</ul>

<h2 id="where-i-found-big-challenges-in-learning-automated-testing-for-embedded-systems">Where I found big challenges in learning automated testing for embedded systems</h2>

<p>As I’ve been diving deeper into the world of embedded systems and mirocontrollers, I wanted to make sure that I had a handle on how to apply TDD in the world of C cross-compiling.  So I picked up copy of James Grenning’s book <a href="https://pragprog.com/titles/jgade/test-driven-development-for-embedded-c/">TDD for Embedded Systems</a>.  Among the two testing frameworks he demonstrated, I preferred <a href="http://www.throwtheswitch.org/unity">Unity</a> this is mainly because I am still a relative novice in C and I’d prefer to avoid mixing languages at this time.  The other option <a href="http://cpputest.org/">CppUTest</a> is written in C++.</p>

<p>One complication to this is that the library supplied by the teensy is a mix of c &amp; C++.  Even in this tutorial we will encounter a C++ module and learn how to deal with it from our application code.</p>

<p>As a relative novice in c-programming, just getting Grenning’s examples to build took a pretty big effort.  Eventually I got through and voila, my reward was a suite of passing tests that <strong>could NOT</strong> be built on any particular device.  While it makes sense within the scope of his book, I found myself floundering a bit in trying to figure out how to get this well-tested &amp; decoupled book code to deploy onto an actual device.</p>

<p>Embedded TDD tries to offer its practitioner the promise of development without hardware.  It’s an attractive but rather lofty goal for a small team. At the end of the day, if well-tested code doesn’t perform as expected on the board, then the whole effort is wasted.</p>

<p>The open-source <a href="https://www.pjrc.com/teensy">Teensy</a> boards serve as a good starting point for Arduino developers learning how to get into ARM Cortex.</p>

<p>The <a href="https://www.pjrc.com/teensy/td_download.html">Teensyduino</a> package contains a starter makefile and blinky source code.  To ensure the necessary toolchain is set-up on your computer, please make sure you can build and run it before attempting to use this code.</p>

<h2 id="rake-vs-make-for-embedded-development">Rake vs Make for embedded development</h2>

<p>Slowly but surely, I’m learning to navigate makefiles, they are quite cryptic to read and learn but I as far as I can tell, they are still pretty much industry standard.  From a TDD &amp; multitargeting perspective, they suffer from a couple important drawbacks:</p>
<ol>
  <li>They are a domain-specific language that is super hard to read for the uninitiated</li>
  <li>They don’t have a way to test and protect against regressions <strong>Most important</strong></li>
</ol>

<p>While scripting languages often suffer speed wise, in this case, I feel that having a fully object-oriented language more than makes up for it and I’m very fond of <a href="https://rspec.info/">RSpec</a> for its expressiveness and readability.  As the ruby version of Make, Rake does a lot of the heavy lifting for us on this job.  If you are curious to learn more about Rake, I pulled a lot from <a href="https://avdi.codes/rake-part-1-basics/">this blog</a> while learning how rake handle dependencies and filetypes.  I leaned heavily on ElectronVector’s blog post on using <a href="http://www.electronvector.com/blog/using-gcc-for-automatic-c-language-dependency-management-with-rake">rake to drive GCC</a>.  This example is basically a TDD version of that rakefile.</p>

<p>Unity provides a <a href="https://github.com/ThrowTheSwitch/Unity/tree/master/examples/example_3">starter rakefile</a> <strong>without a test harness</strong>.  It works well but in order for me to put a test harness around it, I needed to extract it to a class.</p>

<h2 id="getting-started">Getting started</h2>

<p>To get started, let’s take an inventory of what we have to work with.<br />
If you mainly use arduino studio you may not have used <code class="language-plaintext highlighter-rouge">make</code> very much</p>

<h3 id="getting-your-toolchain-in-place">Getting your toolchain in place</h3>

<ol>
  <li>The makefile and starter source code can be found at <a href="https://www.pjrc.com/teensy/td_download.html">Teensyduino</a>. For my Teensy 3.6, the makefile is located at <strong>hardware/teensy/avr/cores/teensy3</strong>.  If you have a Teensy4, it will be at <strong>cores/teensy4</strong> and so on.</li>
</ol>

<p><em>IMPORTANT: Make sure your computer’s teensy buildchain is correctly setup by running <code class="language-plaintext highlighter-rouge">make</code> within this folder and seeing blinky running on your device</em>.  Windows users can get <em>make</em> by installing <a href="https://osdn.net/projects/mingw/downloads/68260/mingw-get-setup.exe/">MingW</a> (core, C++ &amp; msys) which has a helpful little <a href="https://nerdyelectronics.com/install-mingw-on-windows-for-make/">walkthrough for embedded developers here</a>.  If you prefer a package manager, there is also a <a href="https://community.chocolatey.org/packages/make">Chocolatey package</a></p>

<p>The teensy loader should pop-up automatically.</p>

<p><img src="/assets/images/teensy_rake/teensy_loader.png" alt="teensy_loader_interface" /></p>

<p>The programming status bar should pop-up as well.</p>

<p><img src="/assets/images/teensy_rake/teensy_programming.png" alt="teensy_programming_dialog" /></p>

<p>Keep an eye out for both of these as you are progressing through the test-suite</p>

<ol>
  <li>The rakefile and starter source code within <a href="http://www.throwtheswitch.org/unity">example 3 of Unity</a> (located at examples/examples3). <em>Make sure your computer’s ruby buildchain is correctly setup by running <strong>rake</strong> within this folder.  Unity should report a couple tested modules; each with some successful, failed and ignored tests</em>.</li>
</ol>

<h3 id="setting-up-a-new-project">Setting up a new project</h3>

<ul>
  <li>
    <p>After cloning the <a href="">teensy_tdd_rake repo</a>, run <code class="language-plaintext highlighter-rouge">bundle install</code> to set-up rake and rspec/</p>
  </li>
  <li>Copy the teensy3 folder into the root folder</li>
  <li>Copy the unity.framework folder into the root folder. <em>you may want to include it as a git submodule using <code class="language-plaintext highlighter-rouge">git submodule add https://github.com/ThrowTheSwitch/Unity</code></em></li>
</ul>

<p>With that, you should now have the following folder tree:</p>

<p><img src="/assets/images/teensy_rake/teensy_rake_folders.png" alt="teensy_rake folder layout" /></p>

<p>To test the buildchain, We are going to run first run with teensy disconnected, then with it connected.</p>

<h4 id="1-disconnect-the-teensy-and-type">1. Disconnect the teensy and type</h4>
<p><code class="language-plaintext highlighter-rouge">bundle exec rspec</code></p>

<p>It should return with <code class="language-plaintext highlighter-rouge">XX examples and 1 failure</code>.  What’s the failure?  Well, I’ve started you off on step 1 of the Red-Green-Refactor cycle.   We’ll come back to the failed test a little later..</p>

<h4 id="2-connect-the-teensy-and-type">2. Connect the teensy and type</h4>
<p><code class="language-plaintext highlighter-rouge">bundle exec rspec</code></p>

<p>If you are running on an ubuntu install, this may work immediately.  However, 
The Rakefile_helper will attempt identify if a device is connected at usb address <em>/dev/ttyACM0</em> or <em>/dev/ttyACM1</em>. These are the default usb locations on both my Linux Mint &amp; ArchLinux installs.  If the addresses on your system are different you can update within the file <code class="language-plaintext highlighter-rouge">system.yml</code>.</p>

<p>If it identifies that a teensy is connected, it will run those tests, otherwise it will skip them.  The teensy tests are a bit slow but it’s the best way I’ve found so far to do an <a href="https://thoughtbot.com/blog/testing-from-the-outsidein">outside-in</a> test of the build.</p>

<p>If you’ve made it this far, congrats!  You’ve now got an open-source, TDD build system for your teensy to get you going on your way towards TDD and/or multi-targetting.</p>

<h2 id="testing-and-iterating">Testing and Iterating</h2>

<p>Regardless of what kind of software you are building, there will be some variation of a testing pyramid similar to the picture below.  At the top are the ‘acceptance or feature’ tests which cover all of the important functionalities that your users expect to see.  These are slow to run and require the physical hardware and probably customized bench &amp; field testing programs.  Writing these tests can help to clarify your thinking about what exactly you are expecting your software solution to achieve for your users.</p>

<p><img src="/assets/images/teensy_rake/TDD_pyramid.png" alt="The TDD Pyramid" /></p>

<p><em>Note: this is not my picture.  the <a href="https://medium.com/@joatmon08/test-driven-development-techniques-for-infrastructure-a73bd1ab273b">source is here</a></em></p>

<p>In the case of our TDD build-system, our interface is the Rakefile.  The following commands are defined:</p>

<p>For testing:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">prepare_for_tests</code></li>
  <li><code class="language-plaintext highlighter-rouge">unit</code> (the default, will run on the basic <code class="language-plaintext highlighter-rouge">rake</code> command)</li>
</ul>

<p>For deployment:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">deploy</code>  Loads the binary to the target via USB</li>
  <li><code class="language-plaintext highlighter-rouge">prepare_binary</code>  Links the compiled source code and converts the binary into a hex ready for upload</li>
  <li><code class="language-plaintext highlighter-rouge">build_main</code>  compiles your application code</li>
  <li><code class="language-plaintext highlighter-rouge">build_target</code> compiles all sources provided by the target into a static library that can be linked in at a later stage</li>
</ul>

<p>Since the task ‘unit’ is the default, typing <code class="language-plaintext highlighter-rouge">rake</code> is equivalent to typing <code class="language-plaintext highlighter-rouge">rake unit</code>. Try it now if you need any convincing.</p>

<p>Before</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Clearing build directory
Running unit tests
Running system tests...</code></pre></figure>

<h2 id="the-first-build-system-spec">The first build-system spec.</h2>
<p><code class="language-plaintext highlighter-rouge">commit 9393d17</code></p>

<p><em>Pro tip: If you cloned the github project above, you can check your progress against these commit using <code class="language-plaintext highlighter-rouge">git diff &lt;commit_id&gt; &lt;filename&gt;</code></em>
<em>For example.  If you are working on the file <strong>src/LedController.c</strong> and cant seem to get the same result as me, try typing git <code class="language-plaintext highlighter-rouge">diff 9393d17 src/LedController.c</code></em></p>

<p>Before going forward, let’s have a look at layout of the <strong>spec/</strong> folder</p>

<p><img src="/assets/images/teensy_rake/teensy_rake_spec_folders.png" alt="teensy_rake spec folder layout" /></p>

<p>There are 3 files that defines specs:</p>
<ol>
  <li><strong>Rakefile_spec.rb</strong> - As mentioned above, this is the interface for our buildsystem.</li>
  <li><strong>spec/rakefile_helper_spec.rb</strong> - All of the application logic and customization is found in here.</li>
  <li><strong>spec/helper_methods/helper_methods_spec.rb</strong> - These are methods to assist in setting up and tearing down tests.  They mostly perform string and file manipulation.</li>
</ol>

<p>Let’s look again at the failing spec by hitting <code class="language-plaintext highlighter-rouge">bundle exec rspec</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">1<span class="o">)</span> Rakefile defaults to unit tests
   Failure/Error: expect<span class="o">(</span>check_for_file<span class="o">(</span>target_exe_filepath<span class="o">))</span>.to eq<span class="o">(</span><span class="nb">true</span><span class="o">)</span>
   
     expected: <span class="nb">true
          </span>got: <span class="nb">false</span>
   
     <span class="o">(</span>compared using <span class="o">==)</span>
   
     Diff:
     @@ <span class="nt">-1</span> +1 @@
     <span class="nt">-true</span>
     +false
     
   <span class="c"># ./spec/Rakefile_spec.rb:43:in `block (2 levels) in &lt;top (required)&gt;`</span></code></pre></figure>

<p>During this spec, Rspec was told to expect something to be true. Those instructions are located at <strong>/spec/Rakefile_spec.rb:43</strong>.  Let’s have a look at that file &amp; line.  We see the offending spec:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">'defaults to unit tests'</span> <span class="k">do</span>
	<span class="n">target_exe_filepath</span> <span class="o">=</span> <span class="n">build_folder</span> <span class="o">+</span> <span class="s1">'TestLedController.exe'</span>
	<span class="sb">`rake`</span>

	<span class="n">expect</span><span class="p">(</span><span class="n">check_for_file</span><span class="p">(</span><span class="n">target_exe_filepath</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>In case you are not familiar with Ruby, here’s what the spec is requesting in plain english:</p>

<p><code class="language-plaintext highlighter-rouge">Expect to find a file named 'TestLedController.exe' inside of the build folder</code></p>

<p>You can <a href="http://www.throwtheswitch.org/build/build-unity">check this page</a> for more details about how Unity is built.  For our purposes, we just need to know that the Unity build was triggered rather than the teensy build.  But why did it fail?  Well, this Rakefile instucts Unity to search in the <strong>test/</strong> folder for files named <strong>TestSomeModule.c</strong>.  There is no file like that so the test fails.  We are Red, in the Red-Green-Refactor loop.  Let’s create a blank file with the specified name <strong>TestLedController.c</strong> and try again</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Clearing build directory
Running unit tests
Running system tests...

gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ build/TestLedController_Runner.c <span class="nt">-obuild</span>/TestLedController_Runner.o

gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ <span class="nb">test</span>/TestLedController.c <span class="nt">-obuild</span>/TestLedController.o

<span class="nb">test</span>/TestLedController.c:1: warning: ISO C forbids an empty translation unit <span class="o">[</span><span class="nt">-Wpedantic</span><span class="o">]</span>

gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/TestLedController_Runner.o build/TestLedController.o <span class="nt">-o</span> build/TestLedController.exe</code></pre></figure>

<p>Rake successfully recognized the new file! Great!  It began compiling its modules, first <strong>TestLedController_Runner.o</strong> and then <strong>TestLedController.o</strong> before exiting with an error.  New information and new errors is progress in the TDD cycle.</p>

<p>Here’s the basic structure of a test in unity.  Try adding it to the empty file to see what you get…</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_Led_Controller_does_a_thing_and_fails</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TEST_FAIL_MESSAGE</span><span class="p">(</span><span class="s">"Our greatest glory is not in never falling, but in rising every time we fall. - Confucius"</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Clearing build directory
Running unit tests
Running system tests...
gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ unity.framework/src/unity.c <span class="nt">-obuild</span>/unity.o
gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ build/LedController_Runner.c <span class="nt">-obuild</span>/TestLedController_Runner.o
build/TestLedController_Runner.c:5:10: fatal error: LedController.h: No such file or directory
    5 | <span class="c">#include "LedController.h"</span>
      |          ^~~~~~~~~~~~~
compilation terminated.
rake aborted!</code></pre></figure>

<p>Ok, this time it couldn’t find the header file.  For those of you who are still getting used to the difference between source and header files.  One way to think about it is that the header file defines the interface of the module.  So this is a good time to revisit the concept of SOLID and think about what we want this LedController.c to do.  Better yet, let’s evaluate how ‘SOLID’ the teensy starter code in <strong>main.cpp</strong> is.</p>

<h3 id="solidifying-maincpp">SOLIDifying main.cpp</h3>

<ul>
  <li><strong>S Single Responsibility Principle</strong> - What is the responsibility of main.cpp right now?  Well, since it is the only file, it does everything.  Even in this very simple application, there are multiple responsibilities involved.
    <ol>
      <li>Start-up and initialize the board and name important variables</li>
      <li>Toggle an led ON or OFF</li>
      <li>Keep track of time and perform an action after a specified amount of time</li>
    </ol>
  </li>
  <li>
    <p><strong>O Open Closed Principle</strong> - Let’s say you want to add some new functionality, for example a different LED that flashes on a different interval.  How would you do that? Would you extend main.cpp with new details or would you copy and paste the new pin number and interval into <strong>main.cpp</strong>?  Certainly the easier thing to do is copy/paste main.cpp and that would work fine for this example.  However, in that case you are not extending main.cpp and you are modifying it.  So the easy/obvious route is offside of OCP.</p>
  </li>
  <li>
    <p><strong>L Liskov Substitution Principle</strong> - Liskov substitution principle (LSP) evaluates the interface.  However as a single file monolith, main.cpp does not even have an interface!  So from that perspective, adding an interface is the obvious step to take to make this application more SOLID with a capital ‘L’!</p>
  </li>
  <li><strong>I Interface Segregation Principle</strong> - So what interfaces do we need?  Well based on the 3 repsonsibilities mentioned in section 1, it would appear that main needs 3 interfaces:
    <ol>
      <li>For initialization and for establishing the important constant and variables needed by the application</li>
      <li>For reading and writing Led pins</li>
      <li>For monitoring time and taking action based on that information</li>
    </ol>
  </li>
  <li><strong>D Dependency Inversion Principle</strong> - Does the high level code (<strong>main.cpp</strong>) depend on the lower-level modules? Well, it depends on one interface: <strong>Arduino.h</strong>.  What does Arduino depend on? Open the file and have a look:</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">"WProgram.h"</span><span class="cp">
#include</span> <span class="cpf">"pins_arduino.h"</span></code></pre></figure>

<p><strong>pins_arduino.h</strong> is almost 300 lines of constant definitions while 
<strong>WProgram</strong> depends on 24 different modules.</p>

<p>If you are preparing to move from teensy to a different board (or vice-versa), be prepared for a LOT of reading, digging and research. I can personally attest to this.  I learned a lot, but it can take a very long time.  Nobody wants to be dealing with those sorts of challenges on a deadline.</p>

<p>That’s all a lot to take in but let’s take it step by step.</p>

<h2 id="adding-a-unity-test">Adding a unity test</h2>

<h3 id="defining-the-interface-with-testledcontrollerc">Defining the interface with TestLedController.c</h3>

<p>Looking again at the starter sourcecode for blinky.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/main.cpp</span>

<span class="cp">#include</span> <span class="cpf">&lt;Arduino.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pinMode</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">digitalWriteFast</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
		<span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">digitalWriteFast</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
		<span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">pinMode()</code> makes teensy toggleable.  So thats a good place to start. We want to be able to create an <strong>LedController</strong> with a pin number.</p>

<p>Let’s create the header now.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// includes/LedController.h</span>

<span class="cp">#ifndef D_LedController_H
#define D_LedController_H
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">pinNumber</span><span class="p">);</span>

<span class="cp">#endif</span></code></pre></figure>

<p>When we run the tests,</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">clearing build directory
Running unit tests
Running system tests...
gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ unity.framework/src/unity.c <span class="nt">-obuild</span>/unity.o
gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ build/TestLedController_Runner.c <span class="nt">-obuild</span>/TestLedController_Runner.o
gcc <span class="nt">-DUNITY_INCLUDE_DOUBLE</span> <span class="nt">-DUNITY_SUPPORT_TEST_CASES</span> <span class="nt">-D__MK66FX1M0__</span> <span class="nt">-DF_CPU</span><span class="o">=</span>48000000 <span class="nt">-DTEST</span> <span class="nt">-c</span> <span class="nt">-m32</span> <span class="nt">-Wall</span> <span class="nt">-Wno-address</span> <span class="nt">-pedantic</span> <span class="nt">-Isrc</span>/ <span class="nt">-Iunity</span>.framework/src/ <span class="nt">-Itest</span>/ <span class="nt">-Iincludes</span>/ <span class="nt">-Iteensy3</span>/ <span class="nt">-Imocks</span>/ <span class="nt">-Iteensy3</span>/avr/ <span class="nt">-Iteensy3</span>/util/ <span class="nb">test</span>/TestLedController.c <span class="nt">-obuild</span>/TestLedController.o
gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/unity.o build/TestLedController_Runner.o build/TestLedController.o <span class="nt">-o</span> build/TestLedController.exe
build/TestLedController.exe
<span class="nb">test</span>/TestLedController.c:14:test_LedController_is_off_upon_creation:FAIL: Our greatest glory is not <span class="k">in </span>never falling, but <span class="k">in </span>rising every <span class="nb">time </span>we fall. - Confucius</code></pre></figure>

<p>Ok! So we have our first test!  Confucius isn’t telling us anything useful anymore, let’s write a test that describes what the code is (or isn’t doing). For the rest of the code snippets, I’m going to only include the bits that change.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedController.c</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_LedController_is_off_upon_creation</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">virtualPin</span> <span class="o">=</span> <span class="mh">0xface</span><span class="p">;</span>									<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><em>[1] I find it useful to put in recognizably nonsense numbers or strings in the data of my tests.  It can help you catch your mistakes faster</em></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/unity.o build/TestLedController_Runner.o build/TestLedController.o <span class="nt">-o</span> build/TestLedController.exe
/usr/bin/ld: build/TestLedController.o: <span class="k">in function</span> <span class="sb">`</span>test_LedController_is_off_upon_creation<span class="s1">':
TestLedController.c:(.text+0x57): undefined reference to `LedController_Create'</span></code></pre></figure>

<p>Unity can’t find the function.  Because we haven’t written it yet. So here’s our chance to finally make our code do something.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span></code></pre></figure>

<p>Which returns:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:16:test_LedController_is_off_upon_creation:FAIL: Expected 0 Was 0xFACE

<span class="nt">-----------------------</span>
1 Tests 1 Failures 0 Ignored 
FAIL</code></pre></figure>

<p>Ok! now let’s make it pass</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>So there it is, your first passing test on a teensy. Let’s keep going. This test will virtually turn on an Led</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//test/TestLedController.c</span>

<span class="kt">void</span> <span class="nf">test_LedController_TurnOn_Led_seven</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">virtualPin</span><span class="p">;</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Unity will complain that it doesn’t know about the new function, as it should.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c: In <span class="k">function</span> ‘test_LedController_TurnOn_Led_seven’:
<span class="nb">test</span>/TestLedController.c:23:3: warning: implicit declaration of <span class="k">function</span> ‘LedController_TurnOn’<span class="p">;</span> did you mean ‘LedController_Create’? <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
   23 |   LedController_TurnOn<span class="o">(</span>7<span class="o">)</span><span class="p">;</span>
      |   ^~~~~~~~~~~~~~~~~~~~~~
      |   LedController_Create</code></pre></figure>

<p>A quick note about the function names, at first I was annoyed by developers putting the module name in the front of each method call. Over time though, I came to appreciate that it makes a big difference in keeping things organized.  It might seem weird to readers coming from an object-oriented language but it does really help!</p>

<p>So next we add <strong>LedController_TurnOn()</strong> to the header file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">TestLedController.c:<span class="o">(</span>.text+0xc6<span class="o">)</span>: undefined reference to <span class="sb">`</span>LedController_TurnOn<span class="s1">'</span></code></pre></figure>

<p>We’ve seen this before, time to edit the sourcefile.  If you just add the empty function and run <code class="language-plaintext highlighter-rouge">rake</code>, it will fail. Good to see.  You want to see the test failing the way you expect before you implement the desired functionality.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:12:test_LedController_is_off_upon_creation:PASS
<span class="nb">test</span>/TestLedController.c:24:test_LedController_TurnOn_Led_seven:FAIL: Expected 1 Was 0

<span class="nt">-----------------------</span>
2 Tests 1 Failures 0 Ignored 
FAIL</code></pre></figure>

<p>Ok, to achieve the desired functionality, we will make a pointer to the address and mark it static so it’s not accessible to outside callers.  To turn it on, we will make an over-simplification.  This is an example of the Agile principle of ‘selecting the simplest design that could possibly work’.</p>

<p>It’s ok (even encouraged) to oversimplify your solutions during TDD as it is expected to produce a more robust solution than trying to create the complete solution immediately.  These kinds of small, steady, well-tested steps can sometimes help to avoid careless (or rushed) mistakes.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">ledsAddress</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">LedController_TurnOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">ledNumber</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>This should pass. Congratulations, you can now ‘virtually’ turn on your light.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:12:test_LedController_is_off_upon_creation:PASS
<span class="nb">test</span>/TestLedController.c:19:test_LedDriver_TurnOn_Led_seven:PASS

<span class="nt">-----------------------</span>
2 Tests 0 Failures 0 Ignored 
OK</code></pre></figure>

<p>Let’s also make sure we can turn one off.  Just to say we can.  Also to achieve the same level of function as the infamous ‘sample blinky’.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">test_LedController_TurnOff_Led_seven</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">virtualPin</span><span class="p">;</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>After adding the header definitions and empty functions.  You should be at a failing test.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:12:test_LedController_is_off_upon_creation:PASS
<span class="nb">test</span>/TestLedController.c:19:test_LedController_TurnOn_Led_seven:PASS
<span class="nb">test</span>/TestLedController.c:33:test_LedController_TurnOff_Led_seven:FAIL: Expected 0 Was 1

<span class="nt">-----------------------</span>
3 Tests 1 Failures 0 Ignored 
FAIL</code></pre></figure>

<p>It passes by reversing the command in <code class="language-plaintext highlighter-rouge">TurnOn()</code>.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">LedController_TurnOff</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> </code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">commit 38d4ee4</code></p>

<p>So that brings us to our first refactoring opportunity.  One of the ways codebases get out of hand over time is by writing the same instructions over and over in different parts of your code.  Another of the important tenets of programming is <strong>Don’t Repeat Yourself</strong> which is apparently attributed to the writers of Pragmatic Programmer who also published Grenning’s book.  You might say that I’ve drank the kool-aid when it comes to this testing stuff.</p>

<p>At any rate, keeping your code DRY means always being on the lookout for opportunities to bring together duplicated statements into a single definition.  Many practitioners advocate for refactoring after the third duplication.  In our case, we now have a statement that occurs in every test.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span></code></pre></figure>

<p>However, our test about of <code class="language-plaintext highlighter-rouge">LedController_Create()</code> involves a variable declaration beforehand.  So we can’t remove it.  That means we can only remove two of the duplicates but let’s take the opportunity to do it now anyway.  This statement will be required consistenly in upcoming tests anyway so it won’t be two for long:</p>

<p>Here’s how <strong>TestLedController.c</strong> looks after refactoring</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">virtualPin</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_LedController_is_off_upon_creation</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint16_t</span> <span class="n">virtualPin</span> <span class="o">=</span> <span class="mh">0xface</span><span class="p">;</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">virtualPin</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_LedController_TurnOn_Led_seven</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_LedController_TurnOff_Led_seven</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The tests are short and sweet.  That makes a big difference as your codebase &amp; test suite starts to grow.  The faster you can understand what a newly failed test is doing, the more likely you are to identify and fix it quickly as well.</p>

<h4 id="start-on-green-end-on-green-with-refactoring">Start on green, end on green with refactoring</h4>
<p>Sometimes it can be tempting to refactor out a duplication you find while doing some other task.  Don’t do that. You always want a fully passing codebase before you start refactoring or you can get yourself into all kinds of confusing trouble.</p>

<h3 id="turning-on-a-specific-led--a-point-about-binary">Turning on a specific Led (&amp; a point about binary)</h3>
<p>Right now the driver will represents all possible pins in a single binary value.  This is clearly not very useful on a board with multiple pins.  In this case, the 16-bit variable <em>ledsAddress</em> represents 16 pins that represent whether its Led is on (1) or off (0).  So, for example, the binary <em>0000001001000000</em> is equal to the hex value <em>0x240</em> which is equal to <em>576</em> on a decimal scale (the way we are accustomed to counting).  There are lots of binary-hexadecimal-decimal converters available online to help.</p>

<p>Anyways, it’s time to start toggling different pins. Here’s the test:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//test/TestLedController.c</span>

<span class="kt">void</span> <span class="nf">test_LedController_TurnOn_MultipleLeds</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mh">0x240</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The test returns <em>0x0001</em> instead of <em>0x0240</em>, just like we’d coded it earlier.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:15:test_LedController_is_off_upon_creation:PASS
<span class="nb">test</span>/TestLedController.c:22:test_LedController_TurnOn_Led_seven:PASS
<span class="nb">test</span>/TestLedController.c:28:test_LedController_TurnOff_Led_seven:PASS
<span class="nb">test</span>/TestLedController.c:39:test_LedController_TurnOn_MultipleLeds:FAIL: Expected 0x0180 Was 0x0001

<span class="nt">-----------------------</span>
4 Tests 1 Failures 0 Ignored 
FAIL</code></pre></figure>

<p>Time to fix that with a technique called bit-shifting.  This is important in embedded systems so get comfortable with it if you’re not already.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ledNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Which will make your tests pass. So we can move onto the same case but for turning off a specific Led.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">test_LedController_TurnOff_AnLed</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
  <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>It fails with <em>0x0000</em> instead of the intended <em>0x0040</em>. Again this is what we intentionally coded earlier.  You’ll use a different bitwise operate to turn a specific bit to 0.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOff</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ledNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>Which brings everything to passing again.  You could consider refactoring the bitshift into a function that is more expressive of the intention.  Your future teammates will probably thank you for that. Make it static and keep it out of the header since there’s no reason an external call would need to use this function.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">getBitLocationFromLedNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ledNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">|=</span> <span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOff</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>There’s a bit of a nuance to what we’ve done here.  The pins on a teensy can be set to either <a href="https://www.pjrc.com/teensy/td_digital.html">read or write</a>.  This means that a pin set to output (such as an <strong>LedController</strong>) cannot read the actual state of the pin. Instead it has to keep track of the values in its own separate memory location.</p>

<p>Why is this important? Well, it comes down to the difference between state and action. Many embedded systems will use <a href="https://www.state-machine.com/fsm/">finite state machines</a> in order to carry out their tasks.  If you look to the <code class="language-plaintext highlighter-rouge">delay()</code> function in <code class="language-plaintext highlighter-rouge">main()</code>, the processor is occupied during the delay and cannot be asked to do any other tasks.  Using a state machine can help to free up system resources while still keeping track of the various peripherals (such as LEDs).</p>

<p>Let’s look and how to ensure monitoring of state with a test:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/LedController.c</span>

<span class="kt">void</span> <span class="nf">test_LedController_does_not_read_the_LedMemoryMap_for_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">virtualPin</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">virtualPin</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Which fails by returning the memory mapped location declared in the test setup</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedController.c:54:test_LedController_does_not_read_the_LedMemoryMap_for_state:FAIL: Expected 0x0080 Was 0xFFFF</code></pre></figure>

<p>note: this particular Rakefile will only recognize functions that start with <strong>test_&lt; WhateverModule &gt;.c</strong> if you forget to add <code class="language-plaintext highlighter-rouge">test_</code> at the front of the function, the test will not be run.</p>

<p>Here’s what the passing code looks like.  I didn’t include the <code class="language-plaintext highlighter-rouge">Turn_off()</code> function but it works the same:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">ledsImage</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">ledsAddress</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">ledsImage</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">ledsImage</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ledsImage</span> <span class="o">|=</span> <span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">ledsImage</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h2 id="back-to-maincpp">Back to main.cpp</h2>

<p>So now we have a tested <strong>LedDriver</strong>. But it doesn’t actually make any system calls yet.  It’s also not being called by <strong>main.cpp</strong>.  How do we fix that?</p>

<p>Before moving forward, double-check all is working correctly by plugging in the teensy and call<code class="language-plaintext highlighter-rouge">rake clean</code> and then <code class="language-plaintext highlighter-rouge">RAKE_TARGET=teensy rake deploy</code>, to make sure it is loading blinky properly.  Since the test suite cleans up its objects after each build, rake is going to need to rebuild the <code class="language-plaintext highlighter-rouge">teensy3</code> modules.  It takes 10 to 15s on my computer.</p>

<p>first add in the new module to make sure it builds ok. The Rakefile should handle it without complaint.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/main.cpp</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>  <span class="p">.</span>
  <span class="n">rest</span>
  <span class="p">.</span>
  <span class="n">of</span>
  <span class="p">.</span>
  <span class="n">code</span>
  <span class="p">.</span>
<span class="p">}</span></code></pre></figure>

<p>Note: The <code class="language-plaintext highlighter-rouge">extern "C" {}</code> wrapper is important here or you will get a linker error when <strong>main.cpp</strong> tries to call those functions.  NOTE: This kills our ability to use <code class="language-plaintext highlighter-rouge">Serial.println()</code> for debugging but we do still have GDB.</p>

<h3 id="moving-the-system-calls-from-main-into-ledcontroller">Moving the system calls from main into LedController</h3>

<p>within main, there are 3 system calls:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">pinMode(ledNumber, OUTPUT);</code>   which tells the teensy to treat this pin as an output.</li>
  <li><code class="language-plaintext highlighter-rouge">digitalWriteFast(ledNumber, HIGH);</code>  Which applies a high (3.3V) voltage to the pin, causing the connected LED to light.</li>
  <li><code class="language-plaintext highlighter-rouge">digitalWriteFast(ledNumber, LOW);</code>  Which applies 0 voltage to the pin, causing the connected LED to go dark.</li>
</ul>

<p>let’s try moving the first call <code class="language-plaintext highlighter-rouge">pinMode()</code> to <strong>LedController</strong>.</p>

<p><strong>LedController.c</strong>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
#include</span> <span class="cpf">"Arduino.h"</span><span class="cp">
</span>
<span class="c1">//...</span>
<span class="c1">//static variables</span>
<span class="c1">//...</span>

<span class="kt">void</span> <span class="nf">LedController_Activate</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><strong>main.cpp:</strong></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;Arduino.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span><span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">activeLeds</span><span class="p">;</span>
    <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">activeLeds</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">boardLed</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="n">LedController_Activate</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="c1">// pinMode(ledNumber, OUTPUT);  // NOTE: this has been commented out</span>

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWriteFast</span><span class="p">(</span><span class="n">boardLed</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">digitalWriteFast</span><span class="p">(</span><span class="n">boardLed</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Try deploying first with <code class="language-plaintext highlighter-rouge">rake deploy_teensy</code>.  That works! What about the tests with <code class="language-plaintext highlighter-rouge">rake</code>?</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/unity.o build/LedController.o build/TestLedController_Runner.o build/TestLedController.o <span class="nt">-o</span> build/TestLedController.exe
/usr/bin/ld: build/LedController.o: <span class="k">in function</span> <span class="sb">`</span>LedController_Activate<span class="s1">':
LedController.c:(.text+0xa8): undefined reference to `pinMode'</span>
collect2: error: ld returned 1 <span class="nb">exit </span>status
rake aborted!</code></pre></figure>

<p>Unity is looking for the <code class="language-plaintext highlighter-rouge">pinMode()</code> function which is buried in the teensy source code.  The build handles that without complaint but Unity is set-up to only reference the files directly called by the test.  You’ll notice that even if we <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code>, the command will still fail because unity does not attempt to find functions buried in submodules.
The way to handle this is called a ‘link-time spy’.  A spy is an alternative, test-only module that allows you to stub a function and give a canned response to it.</p>

<p>comment out <code class="language-plaintext highlighter-rouge">pinMode()</code> and <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code> so that they don’t bother you while setting up the Spy</p>

<p>What kind of behaviour might we expect from the Teensy?  Well, it should be recognized but off if it’s activated. Something like this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedController.c</span>

<span class="kt">void</span> <span class="nf">test_Unactivated_Led_will_return_LED_if_activated</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_Activate</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">TeensySpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="n">TeensySpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Which will naturally fail if we run <code class="language-plaintext highlighter-rouge">rake</code> since those new functions are unrecognized. Comment out that test while we set-up the spy.</p>

<p>Ok, so now we will create a new folder called <code class="language-plaintext highlighter-rouge">mocks</code> where we will place the spy (and it’s tests).</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestTeensySpy.c:</span>

<span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"TeensySpy.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TeensySpy_Create</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tearDown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_on_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">TeensySpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">TeensySpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Nothing fancy here, a simple Create function to get started. Then a couple functions to store the result that was passed: <code class="language-plaintext highlighter-rouge">GetLastId</code> and <code class="language-plaintext highlighter-rouge">GetLastState</code>.</p>

<p>Let’s see what those functions look like within <strong>TeensySpy.h</strong></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeensySpy.h</span>

<span class="cp">#ifndef D_TeensySpy_H
#define D_TeensySpy_H
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">enum</span>
<span class="p">{</span>
  <span class="n">LED_ID_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LED_STATE_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">TeensySpy_Create</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">TeensySpy_GetLastId</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">TeensySpy_GetLastState</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif</span></code></pre></figure>

<p>and then the source:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeesnySpy.c</span>

<span class="cp">#include</span> <span class="cpf">"TeensySpy.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lastId</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lastState</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">TeensySpy_Create</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">lastId</span> <span class="o">=</span> <span class="n">LED_ID_UNKNOWN</span><span class="p">;</span>
  <span class="n">lastState</span> <span class="o">=</span> <span class="n">LED_STATE_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">TeensySpy_GetLastId</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">lastId</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">TeensySpy_GetLastState</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">lastState</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Now we can start to ‘stub out’ the methods that are tucked away in <strong>Arduino.h</strong>.  The one we are focusing on is <em>pinMode()</em> so let’s first create a test:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestTeensySpy.c</span>
<span class="n">include</span> <span class="s">"unity.h"</span>
<span class="cp">#include</span> <span class="cpf">"TeensySpy.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_TeensySpy_set_pinMode_to_Output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">TeensySpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="n">TeensySpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>and then add the function itself:</p>

<p>And then <strong>TeensySpy.c</strong></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">enum</span>
<span class="p">{</span>
  <span class="n">LED_ID_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LED_STATE_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span>
  <span class="n">LIGHT_ON</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">LIGHT_OFF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="n">OUTPUT</span> <span class="o">=</span> <span class="mi">10</span>                       <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">pinMode</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lastId</span> <span class="o">=</span> <span class="n">ledNumber</span><span class="p">;</span>
  <span class="n">lastState</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">These</span> <span class="n">Symbols</span> <span class="n">in</span> <span class="n">the</span> <span class="n">enums</span><span class="p">,</span> <span class="n">make</span> <span class="n">the</span> <span class="n">tests</span> <span class="n">more</span> <span class="n">readable</span><span class="p">.</span> <span class="n">Since</span> <span class="n">they</span> <span class="n">reside</span> <span class="n">in</span> <span class="n">the</span> <span class="n">header</span> <span class="n">file</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Spy</span><span class="p">,</span> <span class="n">they</span> <span class="n">remain</span> <span class="n">unknown</span> <span class="n">to</span> <span class="n">the</span> <span class="n">production</span> <span class="n">code</span><span class="p">.</span></code></pre></figure>

<p><strong>Make sure to add <code class="language-plaintext highlighter-rouge">pinMode</code> to the <code class="language-plaintext highlighter-rouge">TeensySpy.h</code> header file as well!</strong></p>

<p>The tests should pass.</p>

<p>So if we turn our attention back to the <strong>LedController</strong>, we can now uncomment <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code> &amp; <code class="language-plaintext highlighter-rouge">pinMode()</code>.  This breaks the tests because there is no <strong>Arduino.h</strong> in the test environment.
If we create an empty header file:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/Arduino.h</span>

<span class="cp">#ifndef D_Arduino_H
#define D_Arduino_H
#endif</span></code></pre></figure>

<p>We end up with a new failure,</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">src/LedController.c:18:22: error: <span class="s1">'OUTPUT'</span> undeclared <span class="o">(</span>first use <span class="k">in </span>this <span class="k">function</span><span class="o">)</span>
   18 |   pinMode<span class="o">(</span>ledNumber, OUTPUT<span class="o">)</span><span class="p">;</span></code></pre></figure>

<p>That output enum comes from within the teensy library that we’ve stubbed out.  So we can just add a simple enum to satisfy the linker:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/Arduino.h</span>
<span class="k">enum</span>
<span class="p">{</span>
  <span class="n">OUTPUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">pinMode</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">ledNumber</span><span class="p">,</span><span class="kt">uint8_t</span> <span class="n">io</span><span class="p">);</span></code></pre></figure>

<p>Give it a try with <code class="language-plaintext highlighter-rouge">rake clean</code> &amp; <code class="language-plaintext highlighter-rouge">RAKE_TARGET=teensy rake deploy</code></p>

<p>This is a good place to commit your work.</p>

<p><code class="language-plaintext highlighter-rouge">commit 25077e5</code></p>

<p>The LED should be blinking.  From here we can extract the rest of the Led functions into <strong>LedController</strong>.</p>

<p>Here’s the while loop in <strong>main.cpp</strong> with the <strong>LedController</strong> calls added:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="c1">// src/LedController.c</span>

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span></code></pre></figure>

<p>and the pin toggle functions added to <strong>LedController</strong>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ledsImage</span> <span class="o">|=</span> <span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">);</span>
  <span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">ledsImage</span><span class="p">;</span>
  <span class="n">digitalWriteFast</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LedController_TurnOff</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ledsImage</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">));</span>
  <span class="o">*</span><span class="n">ledsAddress</span> <span class="o">=</span> <span class="n">ledsImage</span><span class="p">;</span>
  <span class="n">digitalWriteFast</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
<span class="p">}</span>
  </code></pre></figure>

<p>Naturally, this breaks the tests.  So let’s comment out the digitalWriteFast in <strong>LedController</strong> and then create some stubbed functions for <code class="language-plaintext highlighter-rouge">digitalWriteFast()</code>, within the spy.  We’ll add the tests first of course.<br />
There is an adage in TDD, ‘make it work for none, then make it work for one, then make it work for many’.  What does that mean?
Well, our teensy wouldn’t allow us to toggle a pin on/off if it hadn’t already been set to output would it?  So we shouldn’t allow our Spy to either.  Here’s what that means in a test;</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestTeensySpy.c</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_wont_respond_to_digitalWriteFast_if_no_pinMode_call</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">digitalWriteFast</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">TeensySpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">TeensySpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_set_a_pin_to_HIGH</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">digitalWriteFast</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">TeensySpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">HIGH</span><span class="p">,</span> <span class="n">TeensySpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Here’s a simple if clause that’ll check if the <code class="language-plaintext highlighter-rouge">pinMode(OUTPUT)</code> was called for the correct pin, if not, the Spy resets its values, if yes, it proceeds with the <code class="language-plaintext highlighter-rouge">digitalWriteFast</code> function call.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeensySpy.c</span>

<span class="kt">void</span> <span class="nf">digitalWriteFast</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LEVEL</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lastId</span> <span class="o">==</span> <span class="n">ledNumber</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">lastState</span> <span class="o">=</span> <span class="n">LEVEL</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">lastId</span> <span class="o">=</span> <span class="n">LED_ID_UNKNOWN</span><span class="p">;</span>
      <span class="n">lastState</span> <span class="o">=</span> <span class="n">LED_STATE_UNKNOWN</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We’ll need to add the <code class="language-plaintext highlighter-rouge">HIGH</code> and <code class="language-plaintext highlighter-rouge">LOW</code> definitions to our mock <strong>Arduino</strong> header.  The complete file will look like this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#ifndef D_Arduino_H
#define D_Arduino_H
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">enum</span>
<span class="p">{</span>
  <span class="n">LOW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HIGH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OUTPUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">pinMode</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">ledNumber</span><span class="p">,</span><span class="kt">uint8_t</span> <span class="n">io</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">digitalWriteFast</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">ledNumber</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">level</span><span class="p">);</span>

<span class="cp">#endif</span></code></pre></figure>

<p>The compiler will now complain that <code class="language-plaintext highlighter-rouge">OUTPUT</code> has been declared twice since it’s already in <strong>TeensySpy.h</strong>. We can resolve that by removing it <code class="language-plaintext highlighter-rouge">OUTPUT</code> from the spy.  Now <strong>TestTeensySpy</strong> will complain because that function is now missing.  That is resolved by adding <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code> to &amp; <strong>TestTeensySpy</strong> &amp; <strong>TestLedController</strong>.</p>

<p>All tests passing? A similar test can/should be written for setting <code class="language-plaintext highlighter-rouge">digitalWriteFast(LOW)</code>, since it doesn’t require a change to the logic, it’s good practice to change the code slightly to make the test fail.  For example:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">digitalWriteFast</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">LEVEL</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lastId</span> <span class="o">==</span> <span class="n">ledNumber</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">lastState</span> <span class="o">=</span> <span class="n">LEVEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>

  <span class="p">.</span>
  <span class="p">.</span>
  <span class="p">.</span></code></pre></figure>

<p>will cause the last 2 tests to fail like this</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestTeensySpy.c:13:test_TeensySpy_on_create:PASS
<span class="nb">test</span>/TestTeensySpy.c:19:test_TeensySpy_set_pinMode_to_Output:PASS
<span class="nb">test</span>/TestTeensySpy.c:26:test_TeensySpy_wont_respond_to_digitalWriteFast_if_no_pinMode_call:PASS
<span class="nb">test</span>/TestTeensySpy.c:41:test_TeensySpy_set_a_pin_to_HIGH:FAIL: Expected 0x0001 Was 0x0002
<span class="nb">test</span>/TestTeensySpy.c:50:test_TeensySpy_set_a_pin_to_LOW:FAIL: Expected 0x0000 Was 0x0001</code></pre></figure>

<p>So the tests are indeed checking that the code produces the expected result.  Great!  Remove the ‘+ 1’ and lets get back to <strong>LedController</strong>.</p>

<p>At that point, the tests should pass and <code class="language-plaintext highlighter-rouge">rake deploy_teensy</code> also succeeds.</p>

<p>This is a good time to commit your work.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git add <span class="nt">-A</span>
git commit <span class="nt">-am</span> <span class="s2">"finish extracting led functions into LedController"</span></code></pre></figure>

<p>So now if you uncomment the <code class="language-plaintext highlighter-rouge">digitalWriteFast()</code> calls, the led blinks and the tests pass.</p>

<p><code class="language-plaintext highlighter-rouge">commit 146254c</code></p>

<hr />

<h3 id="extracting-time-functions">Extracting time functions</h3>

<p>So where are we at now?<br />
 if we look at <strong>main.cpp</strong>, we see that there is still a function call to the <strong>Arduino.h</strong> library</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span></code></pre></figure>

<p>the <code class="language-plaintext highlighter-rouge">delay(milliseconds)</code> function causes the board to freeze for the specified time in milliseconds.  Scheduling and timing is a very important function in micro-controllers that are constantly switching between different tasks on specified intervals.
But that poses certain special challenges for testing.  For example.  If you had a task that only repeats once a day, are you going to wait around for that time?  What if you need to support daylight savings time or leap years?  Clearly you need a way to control the internal clock of the device from your test harness.  Grenning’s book used a scheduler to accomplish this.  We are going to mimic this approach although it is arguably overkill to just replace a simple delay function.
Let’s get started.</p>

<h3 id="the-scheduler">The Scheduler</h3>

<p>So the way this is going to work, is that <code class="language-plaintext highlighter-rouge">main()</code> will start a module called <strong>LightScheduler</strong> and give it the variables necessary to function.  The <strong>LightScheduler</strong> will then constantly check the time via callbacks.  When the reported time matches the desired time, <strong>LedScheduler</strong> will call <strong>LedController</strong> to toggle the desired pin.</p>

<p>Let’s use a test to show the different components/function calls.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//test/TestLedScheduler.c</span>

<span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"LedScheduler.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_LedScheduler_ScheduledDelay_didnt_arrive_yet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">499</span><span class="p">);</span>
  <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>What the test is saying is that our <strong>LedScheduler</strong> will create a delay of 500ms, then we will use a fake timer to advance to just before the delay (499ms), and confirm that <strong>LedScheduler</strong> didnt turn on any Leds yet.<br />
We will create an <strong>LedControllerSpy</strong> to watch for the calls of <strong>LedScheduler</strong>. It will be quite similar to the <strong>TeensySpy</strong> we implemented for the <strong>LedController</strong> tests.</p>

<p>This is too much functionality to implement all at once though so we will just comment it out and hold onto it as a reference for now.</p>

<p>Even still, we’ll need to add an empty header to make sure the test suite still compiles:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// includes/LedScheduler.h</span>

<span class="cp">#ifndef D_LedScheduler_H
#define D_LedScheduler_H
</span>
<span class="cp">#endif</span></code></pre></figure>

<p>Here’s a much simpler test to get started with.  It requires us to setup a new spy which we’ll call <strong>LedControllerSpy</strong>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedScheduler.c</span>

<span class="cp">#include</span> <span class="cpf">"LedControllerSpy.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">virtualPin</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">test_LedScheduler_No_Lights_On_Initialization</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="n">virtualPin</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>We’ll also comment that out and now start out with a test of the <strong>LedControllerSpy</strong> itself.  It’s going to be quite similar to <strong>TeensySpy</strong> that we wrote earlier.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestLedControllerSpy.c</span>

<span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"LedControllerSpy.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_LedControllerSpy_on_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_Create</span><span class="p">();</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Which is satisfied by the following header:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/LedControllerSpy.h</span>

<span class="cp">#ifndef D_LedControllerSpy_H
#define D_LedControllerSpy_H
</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>
<span class="k">enum</span>
<span class="p">{</span>
  <span class="n">LED_ID_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LED_STATE_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
  <span class="n">LED_OFF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LED_ON</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">LedControllerSpy_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">ledsAddress</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">LedControllerSpy_GetLastId</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">LedControllerSpy_GetLastState</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif</span></code></pre></figure>

<p>and sourcefile:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/LedControllerSpy.c</span>

<span class="cp">#include</span> <span class="cpf">"LedControllerSpy.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lastId</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lastState</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">LedController_Create</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">ledsAddress</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lastId</span> <span class="o">=</span> <span class="n">LED_ID_UNKNOWN</span><span class="p">;</span>
  <span class="n">lastState</span> <span class="o">=</span> <span class="n">LED_STATE_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">LedControllerSpy_GetLastId</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="n">lastId</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">LedControllerSpy_GetLastState</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">lastState</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>So now if we uncomment the test within <strong>testLedScheduler.c</strong> we get a failure:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedScheduler.c:26:test_LedScheduler_No_Lights_On_Initialization:
FAIL: Expected 0xFFFF Was 0x0000</code></pre></figure>

<p>We can solve that by creating the spy in the test <code class="language-plaintext highlighter-rouge">setUp</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestLedControllerSpy.c</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">ledsAddress</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Great! Now let’s turn on a light.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//mocks/TestLedControllerSpy.c</span>

<span class="kt">void</span> <span class="nf">test_LedControllerSpy_remembers_light_after_TurnOn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ON</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>And make it pass by adding the function to <strong>LedControllerSpy</strong>. Note we don’t need to add it to the header file since it is already defined in <strong>LedController.h</strong> which is <code class="language-plaintext highlighter-rouge">#included</code> in <strong>LedControllerSpy.h</strong>.  This makes sure that the real functions being called by our spy is consistent with the production code.</p>

<p>The test to test for turning an Led off is identical so I won’t repeat it here but you should definitiely write it!  We can now move on to the time aspect of our still commented test in <strong>LedSchedulerTest</strong>.</p>

<p><code class="language-plaintext highlighter-rouge">commit 0a032ac</code></p>

<h2 id="faking-time">Faking Time</h2>
<p>Depending on your application, time management may be hugely important and embedded systems face all sorts of challenges with handling time.  For our tests, we need to be able to fake the time on our board to create all of the different hypothetical situations we might need it to respond to.</p>

<p>In our little example here, we just need to make sure that <strong>LedScheduler</strong> correctly implements the delay function.  So we need to fake that delay.  We’ll start by adding the tests to <strong>mocks/FakeTimeServiceTest.c</strong>.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestFakeTimeService.c</span>

<span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"FakeTimeService.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TimeService_Create</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_FakeTimeService_on_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">MILLISECONDS_UNKNOWN</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_FakeTimeService_sets_time</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">77</span><span class="p">);</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">77</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The header <strong>FakeTimeService.h</strong> will look like this:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/FakeTimeService.h</span>

<span class="cp">#ifndef D_FakeTimeService_H
#define D_FakeTimeService_H
</span>
<span class="cp">#include</span> <span class="cpf">"TimeService.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span><span class="n">MILLISECONDS_UNKNOWN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="cp">#endif</span></code></pre></figure>

<p>Which will fail because it can’t find <strong>TimeService.h</strong>. The real <strong>TimeService.c</strong> is where we will put our teensy specific delay function a little later.  But we will need to create the header now:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// includes/TimeService.h</span>

<span class="cp">#ifndef D_TimeService_H
#define D_TimeService_H
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Time</span> <span class="n">Time</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">Time</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">milliseconds</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">TimeService_GetTime</span><span class="p">(</span><span class="n">Time</span> <span class="o">*</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">TimeService_Create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">TimeService_Destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#endif </span></code></pre></figure>

<p>Using <code class="language-plaintext highlighter-rouge">typedefs</code> &amp; <code class="language-plaintext highlighter-rouge">structs</code> in <strong>c</strong> is something that I’m still getting a hang of but using it for our Time abstraction is helpful since it allows us to add other types of time that might be relevant to the system at a later date (day, minute, etc).  However, all we need right now is milliseconds so this header might seem a little overkill.</p>

<p>This is the passing code:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/FakeTimeService.c</span>

<span class="cp">#include</span> <span class="cpf">"FakeTimeService.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="n">Time</span> <span class="n">fakeTime</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">TimeService_Create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fakeTime</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="n">MILLISECONDS_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TimeService_Destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TimeService_GetTime</span><span class="p">(</span><span class="n">Time</span> <span class="o">*</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">time</span><span class="o">-&gt;</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="n">fakeTime</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">fakeTime</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="n">milliseconds</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Tests pass, sweet, now we can move back to the <strong>TestLedScheduler</strong>.  Using the ‘make it work for none, then one, then many’ methodology, we will gradually add the scheduling, test by test</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestLedScheduler.c</span>

<span class="cp">#include</span> <span class="cpf">"FakeTimeService.h"</span><span class="c1"> //add this to the top</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">test_LedScheduler_No_Schedule_No_Action_Taken</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">365</span><span class="p">);</span>
  <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>we’ll need to add <code class="language-plaintext highlighter-rouge">LedScheduler_WakeUp();</code> to the <strong>LedScheduler.h</strong> and just an empty function in <strong>src/LedScheduler.c</strong> will be sufficient to make the test pass.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="cp">#include</span> <span class="cpf">"LedScheduler.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">LedScheduler_WakeUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span></code></pre></figure>

<p>From here we are finally ready to uncomment the test from the beginning of this section. Here it is again:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedScheduler.c</span>

<span class="kt">void</span> <span class="nf">test_LedScheduler_ScheduledDelay_didnt_arrive_yet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">499</span><span class="p">);</span>
  <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ID_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_STATE_UNKNOWN</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Again, an empty function will cause the test to pass:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span></code></pre></figure>

<p>And now, finally, we hit the point where we can turn on the Led:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedScheduler.c</span>
<span class="kt">void</span> <span class="nf">test_LedScheduler_ScheduledDelay_just_arrived</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_ON</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Sure enough, it fails:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedScheduler.c:50:test_LedScheduler_ScheduledDelay_just_arrived:FAIL: Expected 0x0004 Was 0xFFFF

<span class="nt">-----------------------</span>
4 Tests 1 Failures 0 Ignored 
FAIL</code></pre></figure>

<p>Like we did with <code class="language-plaintext highlighter-rouge">Time</code>, we are going to use a <code class="language-plaintext highlighter-rouge">typedef struct</code> to house the information of the scheduled event.  This will allow us to create multiple scheduled events and easily add extra parameters later if necessary.  Here’s how it looks:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"TimeService.h"</span><span class="cp">
#include</span> <span class="cpf">"LedScheduler.h"</span><span class="cp">
#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">milliseconds</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ScheduledLedEvent</span><span class="p">;</span>

<span class="k">static</span> <span class="n">ScheduledLedEvent</span> <span class="n">scheduledEvent</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
  <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="n">milliseconds</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">LedScheduler_WakeUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">&lt;</span> <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This triggers a new failure in a previous test:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestLedScheduler.c:19:test_LedScheduler_No_Schedule_No_Action_Taken:FAIL: Expected 0xFFFF Was 0x0000</code></pre></figure>

<p>Our tests have caught another bug for us.  This is why we write them!  We need to initialize <strong>LedScheduler</strong> in an unused state and add a guard to check if a <code class="language-plaintext highlighter-rouge">ScheduledEvent</code> has been created.</p>

<p>First add a <code class="language-plaintext highlighter-rouge">Create</code> function to the test setUp and header:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedScheduler.c</span>

<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedScheduler_Create</span><span class="p">();</span>
  <span class="n">LedControllerSpy_Create</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Then add the function and test to <strong>LedScheduler</strong>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="k">enum</span>
<span class="p">{</span>
    <span class="n">UNUSED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="kt">void</span> <span class="nf">LedScheduler_Create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">UNUSED</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="kt">void</span> <span class="nf">LedScheduler_WakeUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UNUSED</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">&lt;</span> <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Which passes.  So we are now calling <strong>TimeService</strong> and comparing the value to our specified delay in order to trigger the Led.
Let’s add a test for <code class="language-plaintext highlighter-rouge">TurnOff</code> for good measure:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedScheuduler.c</span>

<span class="kt">void</span> <span class="nf">test_LedScheduler_ScheduledDelay_just_arrived_Led_is_on</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
  <span class="n">FakeTimeService_SetMilliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>

  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastId</span><span class="p">());</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="n">LED_OFF</span><span class="p">,</span> <span class="n">LedControllerSpy_GetLastState</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>To make this pass is a matter of checking whether the Led is <em>on</em> or <em>off</em>.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="k">if</span> <span class="p">(</span><span class="n">LedController_IsOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Since this is a new function for <strong>LedController</strong>, we’ll first write a test for it. This requires adding a test to and passing method to <strong>TestLedController</strong>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestLedController.c</span>

<span class="kt">void</span> <span class="nf">test_LedController_knows_if_an_Led_is_On</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">LedController_IsOn</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
  <span class="n">TEST_ASSERT_FALSE</span><span class="p">(</span><span class="n">LedController_IsOn</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>Here’s The passing code for that test:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedController.c</span>

<span class="n">BOOL</span> <span class="nf">LedController_IsOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ledsAddress</span> <span class="o">&amp;</span> <span class="n">getBitLocationFromLedNumber</span><span class="p">(</span><span class="n">ledNumber</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ledNumber</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><em>Note: We’ve added some constants, BOOL, TRUE, FALSE, that don’t exist in the standard libraries but can make C a bit easier to read.  To incorporate these constant, we can create a new includes <strong>common.h</strong> with the following.  It will need to be included in <strong>LedController.h</strong></em></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// includes/common.h</span>

<span class="cp">#ifndef D_Common_H
#define D_Common_H
</span>
<span class="cp">#ifndef BOOL
#define BOOL int
#endif
</span>
<span class="cp">#ifndef TRUE
#define TRUE 1
#endif
</span>
<span class="cp">#ifndef FALSE
#define FALSE 0
#endif
</span>
<span class="cp">#endif</span></code></pre></figure>

<p>Ok, back to <strong>LedScheduler</strong>.  Hmmm it has an error.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/objs/TestLedScheduler.o build/objs/TestLedScheduler_Runner.o build/objs/unity.o build/objs/LedScheduler.o build/objs/LedControllerSpy.o build/objs/FakeTimeService.o  <span class="nt">-o</span> build/TestLedScheduler.exe  <span class="nt">-lm</span>
/usr/bin/ld: build/objs/LedScheduler.o: <span class="k">in function</span> <span class="k">**</span>LedScheduler_WakeUp<span class="k">**</span>:
LedScheduler.c:<span class="o">(</span>.text+0xab<span class="o">)</span>: undefined reference to <span class="sb">`</span>LedController_IsOn<span class="s1">'
collect2: error: ld returned 1 exit status
rake aborted!
ABORT RakefileHelper error: error during linking</span></code></pre></figure>

<p>We usually see this when a function hasn’t been added yet.  What caused this issue?
Well, this is an opportunity to explain a concept that took me ages to wrap my head around: the way the Unity uses the gcc linker to prepare the test files.  Let’s look at the <code class="language-plaintext highlighter-rouge">gcc</code> call that triggered the failure:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc <span class="nt">-lm</span> <span class="nt">-m32</span> build/objs/TestLedScheduler.o 
build/objs/TestLedScheduler_Runner.o 
build/objs/unity.o 
build/objs/LedScheduler.o 
build/objs/LedControllerSpy.o 
build/objs/FakeTimeService.o  
<span class="nt">-o</span> build/TestLedScheduler.exe  <span class="nt">-lm</span></code></pre></figure>

<p>each of the files starting with <em>build/objs</em> will get linked together in order to run the test.  So what’s the issue?  Well, we just edited <strong>LedController.c</strong> which isn’t mentioned in that list.  What we actually needed to do was adjust <strong>LedControllerSpy.c</strong> in order to get the test passing.<br />
I jumped the gun a bit.  But since I wrote a test before implementing the function, it should still be safe.  Let’s adjust the spy now.  We can get away with cruder logic here (don’t forget to <code class="language-plaintext highlighter-rouge">#include "common.h"</code>).</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/LedControllerSpy.c</span>

<span class="n">BOOL</span> <span class="nf">LedController_IsOn</span><span class="p">(</span><span class="kt">int</span> <span class="n">ledNumber</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">lastId</span> <span class="o">==</span> <span class="n">ledNumber</span> <span class="o">&amp;</span> <span class="n">lastState</span> <span class="o">==</span> <span class="n">LED_ON</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>And with that, we are back to passing tests!  We could keep going and add logic to incorporate additional <code class="language-plaintext highlighter-rouge">ScheduledEvents</code>, but that’s not necessary for us just to replace Teensy’s <code class="language-plaintext highlighter-rouge">delay</code> function. So we’re gonna move on from here.</p>

<p><code class="language-plaintext highlighter-rouge">commit 3a1312b</code></p>

<h1 id="hooking-ledscheduler-into-the-teensy">Hooking LedScheduler into the Teensy</h1>

<p>Ok, so now we are ready to actually displace the delay call.  How shall we start?  First let’s convince ourselve we haven’t broken anything (yet) with a</p>

<p><code class="language-plaintext highlighter-rouge">rake clean &amp;&amp; RAKE_TARGET=teensy rake deploy</code></p>

<p>Still flashing? On we go.</p>

<p>As mentioned above, we are going to move <code class="language-plaintext highlighter-rouge">delay()</code> into a newly created <strong>TimeService.cpp</strong>.  Like this:</p>

<p>First, we’ll add <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code>.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//src/TimeService.cpp</span>

<span class="cp">#include</span> <span class="cpf">"TimeService.h"</span><span class="cp">
#include</span> <span class="cpf">"Arduino.h"</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_cpp_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">delay</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="n">TimeService_Delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_cpp_delay</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><em>NOTE: Since <code class="language-plaintext highlighter-rouge">delay()</code> is a .cpp function, it needs to be called from within a cpp file.  However, <strong>LedScheduler.c</strong> will only recognize function defintions declared from within an <code class="language-plaintext highlighter-rouge">extern "C"</code> wrapper.  Going forward, anything calling functions or types from the teensy library should be called from outside the <code class="language-plaintext highlighter-rouge">extern "C"</code> wrapper. Anything called from our own .c files should be inside the wrapper.</em></p>

<p>From there, we can move the looping logic from <strong>main.cpp</strong>, into <strong>LedScheduler</strong> like so:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/main.cpp</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">"LedScheduler.h"</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">"TimeService.h"</span><span class="cp">
</span>  
  <span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
  <span class="p">{</span> 
    <span class="kt">uint16_t</span> <span class="n">activeLeds</span><span class="p">;</span>
    <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">activeLeds</span><span class="p">);</span>
    <span class="n">LedScheduler_Create</span><span class="p">();</span>

    <span class="kt">int</span> <span class="n">boardLed</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
    <span class="n">LedController_Activate</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
    <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="n">boardLed</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>What’s more, we’ve now removed all of the cpp function calls from main.  If you follow Jack Ganssle of the <a href="http://www.ganssle.com/tem-subunsub.html">Embedded Muse</a>, you will probably read multiple criticisms about using cpp in embedded sysems.<br />
Im not going to try to wade into that argument as I still have a lot to learn just in C.
So now we are going to refactor it into a .c file.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/main.c  *RENAMED*</span>

<span class="cp">#include</span> <span class="cpf">"LedController.h"</span><span class="cp">
#include</span> <span class="cpf">"LedScheduler.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="kt">uint16_t</span> <span class="n">activeLeds</span><span class="p">;</span>
  <span class="n">LedController_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">activeLeds</span><span class="p">);</span>
  <span class="n">LedScheduler_Create</span><span class="p">();</span>

  <span class="kt">int</span> <span class="n">boardLed</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
  <span class="n">LedController_Activate</span><span class="p">(</span><span class="n">boardLed</span><span class="p">);</span>
  <span class="n">LedScheduler_ScheduleDelay</span><span class="p">(</span><span class="n">boardLed</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LedScheduler_WakeUp</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Next, we’ll briefly add <code class="language-plaintext highlighter-rouge">TimeService_Delay()</code> into <code class="language-plaintext highlighter-rouge">LedScheduler_WakeUp()</code>.  This is a temporary measure just to convince ourselves that we can deploy to the teensy.  We’ll comment out all of the logic which involves time checking:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="kt">void</span> <span class="nf">LedScheduler_WakeUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Time time;</span>
  <span class="c1">// TimeService_GetTime(&amp;time);</span>

  <span class="c1">// if (scheduledEvent.id == UNUSED)</span>
  <span class="c1">// {</span>
  <span class="c1">//  return;</span>
  <span class="c1">// }</span>
  <span class="c1">// if (time.milliseconds != scheduledEvent.milliseconds)</span>
  <span class="c1">// {</span>
  <span class="c1">//  return;</span>
  <span class="c1">// }</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">LedController_IsOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">TimeService_Delay</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Finally, we’ll also need to add header guards to <strong>TimeServce.h</strong> to or the compiler will get confused that sometimes it is being included in the compilation of a C file and other times for a C++ file</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#ifdef __cplusplus
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
<span class="cp">#endif 
</span>
    <span class="k">typedef</span> <span class="k">struct</span> <span class="n">Time</span> <span class="n">Time</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">Time</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">milliseconds</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="n">TimeService_Delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="n">Time</span> <span class="o">*</span> <span class="p">);</span>
    <span class="kt">void</span> <span class="n">TimeService_Create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">TimeService_Destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#ifdef __cplusplus
</span><span class="p">}</span>
<span class="cp">#endif </span></code></pre></figure>

<p>With that, you should have blinky fully functioning within the modules.  But what about the tests?</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/bin/ld: build/objs/LedScheduler.o: <span class="k">in function</span> <span class="sb">`</span>LedScheduler_WakeUp<span class="s1">':
LedScheduler.c:(.text+0xb5): undefined reference to `TimeService_Delay'</span></code></pre></figure>

<p>So we need to add a stub in the <strong>FakeTimeService</strong> for <code class="language-plaintext highlighter-rouge">TimeService_Delay()</code>. An empty function is fine since we aren’t actually calling it within our tests.  From here, a couple of our tests fail because of the commented out code.</p>

<p>At this point, we can begin implementing the actual functions in <strong>TimeService</strong>.  What should our first test look like?</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestTimeService.c</span>

<span class="cp">#include</span> <span class="cpf">"unity.h"</span><span class="cp">
#include</span> <span class="cpf">"TimeService.h"</span><span class="cp">
#include</span> <span class="cpf">"TeensySpy.h"</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TeensySpy_Create</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_TimeService_GetTime_0_on_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Which initially fails because there is no <code class="language-plaintext highlighter-rouge">delay()</code> function within the scope of this test (ie the 2 headers we’ve declared: <strong>Timeservice.h</strong> and <strong>TeensySpy.c</strong>.</p>

<p>We could add <code class="language-plaintext highlighter-rouge">delay()</code> to our mock header <strong>mocks/Arduino.h</strong>.  But that would reuire us to also generate a fake or mock delay function. 
It’s not obvious to me how to write a test for it and <code class="language-plaintext highlighter-rouge">delay()</code> is not a great function to use anyways since your board isn’t able to do anything else while <code class="language-plaintext highlighter-rouge">delay</code> is executing.</p>

<p>So with that in mind, we are actually going to discard <code class="language-plaintext highlighter-rouge">delay()</code> from here in favour of <a href="https://www.pjrc.com/teensy/td_timing_elaspedMillis.html">ElapsedMillis</a> which you can read more about if you’d like.</p>

<p>On that note, go ahead and comment out <code class="language-plaintext highlighter-rouge">delay</code> now. While you are at it, add <code class="language-plaintext highlighter-rouge">#include &lt;stdint.h&gt;</code> to <strong>mocks/Arduino.h</strong> since <strong>TimeService.cpp</strong> will otherwise get it from the teensy library`</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/TimeService.cpp</span>

<span class="kt">void</span> <span class="nf">TimeService_Delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// delay(milliseconds);</span>
<span class="p">}</span></code></pre></figure>

<p>From here, we end up with a missing function in <strong>TimeService</strong>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">TestTimeService.c:<span class="o">(</span>.text+0x43<span class="o">)</span>: undefined reference to <span class="sb">`</span>TimeService_GetTime<span class="sb">`</span></code></pre></figure>

<p>We already have the function prototype in <strong>TimeService.h</strong> so we can just copy it in as an empty function to get past this error.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestTimeService.c:18:test_TimeService_GetTime_0_on_init:FAIL: Expected 0x0000 Was 0x9488</code></pre></figure>

<p>So we need to stub in the behaviour via <strong>TeensySpy</strong>.</p>

<p>For now, let’s comment out that test and drop one level down the stack to <strong>TestTeensySpy</strong> to add a couple stubs and tests.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestTeensySpy.c</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_stubs_0_elapsedMillis_on_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TeensySpy_GetElapsedMillis</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>To get this passing, we’ll need to declare and initialize our stubbed <code class="language-plaintext highlighter-rouge">elapsedMillis</code> (named <code class="language-plaintext highlighter-rouge">timeCounter</code>);</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeensySpy.c</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lastId</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lastState</span><span class="p">;</span>
<span class="k">static</span> <span class="n">elapsedMillis</span> <span class="n">timeCounter</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">TeensySpy_Create</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">lastId</span> <span class="o">=</span> <span class="n">LED_ID_UNKNOWN</span><span class="p">;</span>
  <span class="n">lastState</span> <span class="o">=</span> <span class="n">LED_STATE_UNKNOWN</span><span class="p">;</span>
  <span class="n">timeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">elapsedMillis</span> <span class="nf">TeensySpy_GetElapsedMillis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">timeCounter</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>What is <code class="language-plaintext highlighter-rouge">elapsedMillis</code>?  Well, if we look in the teensy supplied source files, namely <strong>teensy3/elapsedMillis.h</strong>, we’ll see a class that is only defined if compiled using C++.  That’s an implementation detail we need to be aware of, but the other important item we need is the <code class="language-plaintext highlighter-rouge">unsigned long</code> type.  The real <code class="language-plaintext highlighter-rouge">elapsedMillis</code> provides a rich functionality but for our purposes right now, we just need to declare our own <code class="language-plaintext highlighter-rouge">elapsedMillis</code> type within our mock header</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/Arduino.h</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elapsedMillis</span><span class="p">;</span></code></pre></figure>

<p>After adding <code class="language-plaintext highlighter-rouge">#include "Arduino.h"</code> to <strong>TeensySpy.h</strong> (which will allow us to remove the call to <code class="language-plaintext highlighter-rouge">&lt;stdint.h&gt;</code>, by the way), this should pass.  Now let’s create the ability to advance &amp; reset <code class="language-plaintext highlighter-rouge">elapsedMillis</code> within the spy:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TestTeensySpy.c</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_stubs_can_advance_elapsedMillis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TeensySpy_AdvanceElapsedMillis</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">TeensySpy_GetElapsedMillis</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_TeensySpy_stubs_can_reset_elapsedMillis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TeensySpy_AdvanceElapsedMillis</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  <span class="n">TeensySpy_ResetElapsedMillis</span><span class="p">();</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TeensySpy_GetElapsedMillis</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>which passes with the following:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeensySpy.c</span>

<span class="n">elapsedMillis</span> <span class="nf">TeensySpy_AdvanceElapsedMillis</span><span class="p">(</span><span class="kt">int</span> <span class="n">milliseconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">timeCounter</span> <span class="o">+=</span> <span class="n">milliseconds</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TeensySpy_ResetElapsedMillis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">timeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>From here, we can turn our attention back to <strong>TestTimeService</strong> which is still failing, <code class="language-plaintext highlighter-rouge">TimeService_GetTime()</code> needs to call on <code class="language-plaintext highlighter-rouge">elapsedMillis</code></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/TimeService.cpp</span>

<span class="n">elapsedMillis</span> <span class="n">timeCounter</span><span class="p">;</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="p">.</span>
  <span class="p">.</span>
  <span class="p">.</span>

  <span class="kt">void</span> <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="n">Time</span> <span class="o">*</span> <span class="n">time</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">time</span><span class="o">-&gt;</span><span class="n">milliseconds</span> <span class="o">=</span> <span class="n">timeCounter</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Which gives us a passing test (though we still have 2 failing in <strong>TestLedScheduler</strong>, we’ll get there soon.  How about if we advance the stubbed time?</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//test/TestTimeService.c</span>

<span class="kt">void</span> <span class="nf">test_TimeService_GetTime_after_advancing_spy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TeensySpy_AdvanceElapsedMillis</span><span class="p">(</span><span class="mi">85</span><span class="p">);</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
  <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>It fails with no result.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">test</span>/TestTimeService.c:26:test_TimeService_GetTime_after_advancing_spy:FAIL: Expected 0x0055 Was 0x0000</code></pre></figure>

<p><strong>TimeService</strong> is not seeing the <code class="language-plaintext highlighter-rouge">timeCounter</code> that is being produced by <strong>TeensySpy</strong>.  We’ll need to move the declaration into the <strong>TeensySpy.h</strong> header file in order for it to be visible to external caller modules.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// mocks/TeensySpy.h</span>

<span class="cp">#ifndef D_TeensySpy_H
#define D_TeensySpy_H
</span>
<span class="cp">#include</span> <span class="cpf">"Arduino.h"</span><span class="cp">
</span>
<span class="n">elapsedMillis</span> <span class="n">timeCounter</span><span class="p">;</span></code></pre></figure>

<ul>
  <li><em>GOTCHA: When I attempted this tutorial on ArchLinux, I suddenly got hung up on this step for a couple solid days on a multiple definition error.  ArchLinux uses GCC 11 while Linux Mint (the distro I originally wrote this on uses GCC 9.
Turns our that declaring timeCounter in both <strong>TimeService</strong> and <strong>TeensySpy</strong> passes the default GCC linker options in Mint but not Arch.  I don’t know about MingW/Windows or other distros.</em>
The error is cleared by adding the linker flag <code class="language-plaintext highlighter-rouge">z muldefs</code> to <strong>target_testing.yml</strong> like this:</li>
</ul>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">linker</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">lm</span>
    <span class="pi">-</span> <span class="s">m32</span>
    <span class="pi">-</span> <span class="s">z muldefs</span></code></pre></figure>

<ul>
  <li><em>NOTE: Preventing multiple definitions appears to be more up to date with best practices.  So it seems as though I should indeed by using stubbed functions via a mocked <strong>mocks/Arduino.c</strong> (rather than using <strong>TeensySpy</strong> to change the time during testing.  I may pursue this route in a future revision after I’ve done some more research.</em></li>
</ul>

<p>And with that, both <strong>TimeService</strong> tests are passing.  We can also uncomment the logic within <code class="language-plaintext highlighter-rouge">LedScheduler_WakeUp()</code> to get those tests passing again.</p>

<p>Do we dare uncomment the tested code? Run <code class="language-plaintext highlighter-rouge">rake clean &amp;&amp; rake deploy_teensy</code> first to make sure your blinky is still running and deploying. Then let’s go for it:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// src/LedScheduler.c</span>

<span class="kt">void</span> <span class="nf">LedScheduler_WakeUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
  <span class="n">TimeService_GetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">UNUSED</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">milliseconds</span> <span class="o">!=</span> <span class="n">scheduledEvent</span><span class="p">.</span><span class="n">milliseconds</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">LedController_IsOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">LedController_TurnOff</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">LedController_TurnOn</span><span class="p">(</span><span class="n">scheduledEvent</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// TimeService_Delay(scheduledEvent.milliseconds);</span>
<span class="p">}</span></code></pre></figure>

<p>It waits the proper delay time, flashes on and then stays on. How about the tests? They are compiling and passing. So what’s the deal with the flashing?</p>

<p>Well, the callback is working correctly, but it’s not being reset after triggering the toggle switch.  That’s an easy fix, here’s a test:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// test/TestTimeService.c</span>

<span class="kt">void</span> <span class="nf">test_TimeService_Reset_sets_timeCounter_back_to_0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">TeensySpy_AdvanceElapsedMillis</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
   <span class="n">TimeService_Reset</span><span class="p">();</span>
   <span class="n">TEST_ASSERT_EQUAL_HEX16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TeensySpy_GetElapsedMillis</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Which we can make pass by adding the following to <strong>TimeService.cpp</strong></p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="kt">void</span> <span class="nf">TimeService_Reset</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">timeCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span></code></pre></figure>

<p>If we now replace the commented out <code class="language-plaintext highlighter-rouge">TimeService_Delay()</code> with our <code class="language-plaintext highlighter-rouge">TimeService_Reset()</code>, then we are back to blinky again!</p>

<p>We will need to stub a <code class="language-plaintext highlighter-rouge">TimeService_Reset()</code> call into <strong>FakeTimeService</strong> in order to get our test suite fully passing.  It can be empty since we aren’t changing any functionality with this.</p>

<p><code class="language-plaintext highlighter-rouge">commit 2bbd6b0</code></p>

<p>So there we have it.  A blinky program for Teensy via TDD.</p>

<p>Hope you feel that the effort was worth it.  Testing can be a thankless pursuit in a development effort when timelines and budgets are tight.  The up front effort can make a big difference in keeping a codebase clean and well structured.  Making later changes less painful.</p>

<p>In the next article, we’ll add a second board from a different vendor and see how we can further abstract the interface to handle both.</p>

<p>Happy prototyping!!</p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="open-source" /><category term="embedded" /><category term="teensy" /><summary type="html"><![CDATA[Learn how to create modular code for embedded systems using a Test Driven Development approach]]></summary></entry><entry><title type="html">In flight, I attain a higher consciousness. Fear disappears - Translation of Bertrand Piccard’s interview on La Croix</title><link href="https://sunetrike.com/solar-impulse/in-flight-i-attain-a-higher-consciousness/" rel="alternate" type="text/html" title="In flight, I attain a higher consciousness. Fear disappears - Translation of Bertrand Piccard’s interview on La Croix" /><published>2021-09-23T01:08:07+08:00</published><updated>2021-09-23T01:08:07+08:00</updated><id>https://sunetrike.com/solar-impulse/in-flight-i-attain-a-higher-consciousness</id><content type="html" xml:base="https://sunetrike.com/solar-impulse/in-flight-i-attain-a-higher-consciousness/"><![CDATA[<p>In April, Capt Piccard sat down with the Malo Tresca and the podcast <em>Place des Religions</em> for a discussion about exploration, consciousness and how the <a href="https://solarimpulse.com/efficient-solutions">Solar Impulse Network of 1000 Solutions</a> can contribute to the great existential challenge of the 21st century.  I decided to do a translation into English.  I opted to do this for a few reasons:</p>
<ol>
  <li>Just for fun and French practice</li>
  <li>To reflect more on where Solar Impulse might be heading with its newest initiative and tagline <a href="https://solarimpulse.com/beyond-1000-solutions">Ecology as driving force for economy</a></li>
  <li>I really want to see this initiative succeed</li>
</ol>

<p>Merci à <a href="https://www.lmgconsultancy.com/">LMG Consultancy</a> for double-checking my work! I was reminded that I still have a long road ahead of me on my journey to francophony  :)</p>

<p><a href="https://www.la-croix.com/Religion/PODCAST-Bertrand-Piccard-En-vol-jatteins-degre-conscience-peur-disparait-2021-04-14-1201150811">Here is the link to the podcast</a></p>

<hr />

<p><strong>00:29 - BP</strong></p>

<p><em>D’habitude, tout le monde me parle de mon père et de mon grand-père, qui sont des explorateurs qui ont apporté énormément au 20ème siècle, mais c’est vrai qu’avoir une mère qui vous prend au sérieux comme enfant dans votre recherche de compréhension de la vie, de la mort, de Dieu et des autres, c’est extraordinaire.</em></p>

<p>“Usually everyone talks to me about my father and grandfather, who were explorers that contributed enormously to the 20th century. But it’s really my mother takes you seriously as a child in searching to understand life, death, God and others. It’s extraordinary.”</p>

<hr />

<p><strong>00:33 - MT</strong></p>

<p><em>L’aéronaute suisse, Bertrand Piccard, a réalisé, avec ses coéquipiers, deux tours du monde inédits. L’un à bord d’un ballon, poussé par les vents et l’autre aux commandes de l’avion Solar Impulse, alimenté grâce à l’énergie solaire.</em></p>

<p>Aviator Bertrand Piccard, together with his team, accomplished two 2 unprecedented trips around the wind: in a balloon pushed along by the winds.  On board the airplane Solar Impulse, fed graciously by solar energy.</p>

<hr />

<p><strong>00:46 - MT</strong></p>

<p><em>Pour lui, ces expériences ont été des défis techniques, mais aussi de grands voyages intérieurs. Bertrand Piccard se consacre désormais à un nouveau projet, celui de réunir 1000 solutions rentables pour protéger l’environnement, qu’il compte ensuite soumettre aux grandes instances décisionnaires mondiales. Une idée qu’il a expliqué au pape François, lors d’une entrevue au Vatican en février 2020.</em></p>

<p>For him, These experiences were technical challenges but also great voyages inwards.  Bertrand Piccard has now established a new project. This time to assemble a roster of 1000 profitable solutions for protecting the environment. He plans to submit them to the world’s great decision making bodies.  An idea which he explained to Pope Francis at the Vatican last February.</p>

<hr />

<p><strong>01:12 - MT</strong></p>

<p><em>Je m’appelle Malo Tresca, je suis journaliste à La Croix et j’ai rencontré Bertrand Piccard à Lausanne. Dans ce podcast, des personnalités qui ont fait l’expérience du danger, nous confient leurs grands questionnements spirituels. Vous écoutez la troisième saison de « place des religions ».</em></p>

<p>I am Malo Tresca, I’m a journalist at La Croix and I’m meeting Bertrand Piccard in Lausanne. In this podcast, are the people who have experienced the face of danger and discuss with us their great spiritual questions. You are listening to the third season de place des Religions.</p>

<hr />

<p><strong>01:35 - MT</strong></p>

<p><em>Bonjour Bertrand Piccard.</em></p>

<p>Hi Bertrand Piccard.</p>

<hr />

<p><strong>01:36 - BP</strong></p>

<p><em>Bonjour</em></p>

<p>Hi,</p>

<hr />

<p><strong>01:42 - MT</strong></p>

<p><em>Vous nous faites aujourd’hui voyager à Lausanne, au siège de la Fondation Solar Impulse, dont vous êtes l’initiateur et le président. Le thème de l’aviation est partout dans la pièce où nous nous trouvons, dans ses tableaux, dans ses sculptures. Est-ce que vous pourriez nous redire un peu ce que représente pour vous aujourd’hui ce lieu.</em></p>

<p>We are joining you today in Lausanne, at the HQ of the Solar Impulse Fondation, of which you are founder and president. The aviation theme is everywhere in this room, On the tables and sculptures.</p>

<hr />

<p><strong>01:54 - MT</strong></p>

<p><em>Est ce que vous pourriez nous redire un peu ce que représente pour vous aujourd’hui ce lieu?</em></p>

<p>Can you tell us a bit about what this place represents for you today?</p>

<hr />

<p><strong>01:58 - BP</strong></p>

<p><em>C’est le lieu où je reçois les membres de mon équipe, les journalistes, les invités, simplement ma salle de réunion, de rencontre. Il y a forcément l’histoire de l’aviation parce que j’ai une certaine nostalgie de cette histoire incroyable où des pionniers ont ouvert la voie au risque de leur vie. Et puis, il y a quand même l’autre partie qui est celle de la spiritualité orientale, avec des objets tibétains, birmans, thaïlandais qui sont plus du monde intérieur que du monde extérieur de l’aviation.</em></p>

<p>It’s the place where I meet with my team, journalists and guests, simply my meeting room. I had to incorporate the history of aviation because I have a certain nostalgia about this incredible story where these pioneers have paved the way while risking their lives. Also, there is the other part which is the Oriental Spirituality, with Tibetan, Burmese, Thai objects which are more about the internal world than the exterior world of aviation.</p>

<hr />

<p><strong>02:23 - MT</strong></p>

<p><em>Passionné d’exploration depuis l’enfance, vous aviez de qui tenir avec vos aïeux. Vous êtes devenu l’un des pionniers du vol libre en delta-plane et de l’UL dans les années 1970. Qu’est ce qui vous attirait particulièrement dans cette voie des airs?</em></p>

<p>Passion for exploration since childhood, which you had to keep up with your ancestors. You’ve become the first of the pioneers to fly delta-wing and UL (gliders) in the 1970s. What is it that attracted you to this type of flying?</p>

<hr />

<p><strong>02:35 - BP</strong></p>

<p><em>J’ai eu des « role models », des inspirateurs dans le monde de l’aviation. Des astronautes, Charles Lindberg, tous ces pionniers que j’ai eu la chance de rencontrer quand j’étais enfant. J’habitais aux Etats-unis, j’ai assisté à six décollages d’Apollo, rencontré presque tous les astronautes de la NASA et des pionniers de l’histoire de l’aviation et je les rencontrais après avoir lu dans des livres toutes leurs histoires. Et ça a, pour moi, abolit toute frontière entre le rêve et la réalité. Je rêvais de ça et je les rencontrais.</em></p>

<p>I’ve had several role models in the world of aviation. The astronauts, Charles Lindberg, all the pioneers that I got the opportunity to meet when I was a child. I was living in the United States. I helped out on six Apollo launches and met all the NASA astronauts and other pioneers of the history of aviation and then also came across them in the books about all of their stories. So that, for me, demolished all boundaries between dream and reality. I was dreaming about it and I met them.</p>

<hr />

<p><strong>03:10 - BP</strong></p>

<p><em>Je voyais qu’ils réalisaient l’impossible. Et pour moi, ça a été une immense source d’inspiration. Je me suis dit que j’aimerais être explorateur. J’aimerais aller me confronter à l’inconnu, faire des choses que personne n’a jamais faites. Et j’ai acquis une certaine boussole dans mon cœur qui montrait non pas le Nord, mais qui montrait l’inconnu, tout ce qui n’avait encore jamais été fait. Et quand j’avais 16 ans, j’ai vu voler une des premières ailes Delta qui étaient apparues en Europe et je me suis dit, bien ça, c’est nouveau, ça c’est pour moi.</em></p>

<p>I had seen them realize the impossible. For me, that’s a huge source of inspiration. I told myself that I would like to be an explorer. I would like to go confront the unknown, do the things that no one has ever done. I’ve developed a certain compass in my heart that directs me, not to the North, but to the unknown, everything which has not already been done. Then when I was 16 years old, I saw the flight of one of the first hang-gliders that appeared in Europe and I told myself ‘Ah, this is new, this is for me’.</p>

<hr />

<p><strong>03:28 - BP</strong></p>

<p><em>Ça c’est de nouveau quelque chose à explorer qui n’a pas encore été fait. Et c’est comme ça que j’ai commencé à voler. A 16 ans, je volais sous un triangle de toile, quelques tubes d’aluminium, à plusieurs milliers de mètres d’altitude. Et ce qui était fascinant là dedans, ce n’était pas simplement le fait de découvrir le vol, c’était de se découvrir soi-même. J’étais plutôt timoré à l’époque, je voulais être explorateur, mais en même temps, j’avais peur de monter dans un arbre.</em></p>

<p>This is the new thing to explore which hasn’t already been done. So just like that I started to fly. At 16 years old, I flew under a triangle of canvass, some tubes of aluminum, at several thousand metres altitude. And what was fascinating, was not just the act of learning to fly, it was also about discovering yourself. I was rather fearful at the time. I wanted to be an explorer, but at the same time, I was scared to climb a tree.</p>

<hr />

<p><strong>04:05 - BP</strong></p>

<p><em>Puis, tout à coup, je me retrouvais en aile delta, confronté à moi-même, avec la responsabilité de ma vie entre les mains. Et ça, c’est des moments qui développent une conscience de soi qui est extraordinaire. Et quand on est en relation avec soi-même, quand on se sent vivre à l’intérieur de son corps, on développe une performance insoupçonnée. Et tout à coup, je me suis dit que je suis capable de faire beaucoup, beaucoup plus de choses que ce que je pensais.</em></p>

<p>Then suddenly, I found myself in a hang-glider, confronting myself, with the responsibility for my life in my hands. It’s these moments that develop a self consciousness that is extraordinary. And when one is in touch with their own self, when one feels alive to the core of their body, one develops unexpected performance. And suddenly, I tell myself I am capable of doing a lot.  A lot more things than I can imagine.</p>

<hr />

<p><strong>04:30 - BP</strong></p>

<p><em>Et l’aile delta, pour moi, c’était vraiment de l’initiation au monde de l’exploration, de l’aventure, mais aussi de la spiritualité, parce que je parlais beaucoup de spiritualité avec ma mère. C’était quelque chose de très théorique, puis tout à coup, je voyais à quel point on pouvait avoir ces flashs de conscience, à quel point on pouvait être en parfaite possession de toutes ces ressources dans l’instant présent. Et ça, c’était une révélation.</em></p>

<p>And the hang glider, For me, it’s really the entry into the world, of exploration, of adventure, but also of spirituality. Because I was talking often about spirituality with my mother. It was something very theoretical and suddenly, I was flying and I saw how we can get these flashes of consciousness. How much we can be in perfect possession of all these resources in the present instant. And that, it was a revelation.</p>

<hr />

<p><strong>04:53 - MT</strong></p>

<p><em>Vous avez fait beaucoup de chemin depuis, en 1999, après deux échecs, vous avez bouclé le premier tour du monde en ballon sans escale avec l’Anglais Brian Jones. 19 jours et 21 heures de vol, une odyssée qui a été considérée comme la dernière grande aventure du 20ème  siècle. Qu’est-ce qui vous a vraiment porté à croire, envers et contre tout, que vous pouviez aller au bout de ce rêve impossible?</em></p>

<p>You’ve come a long way since 1999 after two failures. You have accomplished the first non-stop round the world flight in a balloon with Englishman Brian Jones. 19 jours and 21 hours, an odyssey which was considered the last great adventure of the 20th century. What really made you believe, to everybody’s disbelief, that you could complete this impossible dream?</p>

<hr />

<p><strong>05:14 - BP</strong></p>

<p><em>Parce que la seule manière de réussir, c’est d’essayer. C’est vrai que je n’avais pas forcément beaucoup de chances a priori de réussir. Je venais du monde de l’aile delta de l’ULM, c’est vrai que j’avais gagné la course transatlantique en ballon avec un pilote belge, Thomas Straton, qui m’avait invité, donc, m’avait initié au ballon. Mais en même temps, les grands milliardaires qui voulaient être les premiers à faire le tour du monde en ballon avaient déjà construit leurs ballons et ils avaient déjà fait des tentatives, Richard Branson, Steve Fossett, pour en nommer que deux.</em></p>

<p>Because the only way to succeed, is to try. It’s true that I wasn’t necessarily having good a priori odds of success. I was coming from the world of delta-wing and UL gliding. It’s true that I had won the transatlantic balloon race with Belgian pilot, Thomas Straton, who had invited me. Therefore, I had been initiated in balloon. But at the same time, the big billionaires who wanted to be the first to make the balloon world-trip had already constructed their balloons and they had already made the attempts Richard Branson, Steve Fossett, to name just two.</p>

<hr />

<p><strong>05:45 - BP</strong></p>

<p><em>Puis moi, je me suis dit, mais, pourquoi pas moi finalement. Qu’est-ce que j’ai à perdre, si ce n’est d’essayer pour rien. Et finalement, la troisième tentative, j’ai réussi et j’ai fait le premier tour. Mais, pour moi, c’était vraiment une leçon de persévérance, d’apprentissage, de mener des très, très grands projets que tout le monde considérait impossible. Parce que c’est fou, vous vous confrontez à des gens qui se moquent de vous parce que vous ratez la première fois, qui vous disent que c’est de toute façon impossible, que vous n’y arriverez pas.</em></p>

<p>But me, I told myself why not me really? I asked myself what do I have to lose, if not to try for nothing? And then, the third attempt, I succeeded and I completed the first circumnavigation. But for me, it’s really a lesson of perseverance, of learning, of carrying very very big projects that everyone considered impossible. Because it’s crazy you come across people who mock you because you failed the first time and they tell you that it’s in every way impossible and that you won’t make it.</p>

<hr />

<p><strong>06:14 - MT</strong></p>

<p><em>Et c’est là que vous voyez finalement les gens qui sont des vrais pionniers et qui vous accompagnent. Et puis, tous ceux qui ont peur d’essayer quoi que ce soit et pour qui vous êtes une menace si vous réussissez.</em></p>

<p>It’s then that you finally see the the people who are the true pioneers and who will accompany you. As well as all those who are scared to try anything and who will see you as a threat if you succeed.</p>

<hr />

<p><strong>06:35 - BP</strong></p>

<p><em>Je crois que le souvenir le plus extraordinaire c’est le moment qu’il y a entre le décollage et l’atterrissage, c’est à dire les 20 jours eux-mêmes. Ça fait un tout, ça fait une espèce de rêve, ça fait un grand flash émotionnel, qui est teinté de toutes les couleurs qu’on a vues, de tous les paysages qu’on a vus. De tous les gens à qui on a parlé par radio. C’était vraiment un contact exceptionnel avec la planète et cela n’a pas été drôle tous les jours. Il y a eu des moments où c’était assez effrayants. Quand nous étions au-dessus du Pacifique, on s’approchait de l’Équateur et que nous n’avions presque plus de vent. Nous nous sommes perdus aussi dans le golfe du Mexique avec des vents qui étaient tout à fait défavorables pour nous. Et puis, chaque fois, il y a comme une main mystérieuse et invisible qui nous a remi dans la bonne direction et la bonne altitude pour permettre enfin de boucler ce tour.</em></p>

<p>I the most extraordinary souvenir is the moment between the takeoff and the landing. The 20 days themselves.  It makes complete, it makes a space for dreaming, it causes a great flash of emotion which is tinted with all the colours we saw, of all the landscapes that we saw. Of all the people I was speaking to on the radio. It was really an exceptional contact with the planet and it hasn’t been funny everyday. There were moments that were quite frightening. While over the Pacific, approaching the equator and there was very little wind. We were lost as well in the Gulf of Mexico with the winds that were all unfavorable for us. Then, each time, there is like a mysterious, invisible hand which sets us in the right direction and the right altitude allowing us to finally complete the journey.</p>

<hr />

<p><strong>07:25 - MT</strong></p>

<p><em>Il y a quelque chose de l’ordre du lâcher prise, de l’abandon profond aux éléments dans cette expérience de tour du monde en ballon.</em></p>

<p><em>Qu’est ce qu’on ressent profondément, intimement, dans ces moments-là?</em></p>

<p>There is something about the act of letting go, about the deep helplessness to the elements during this experience of circling the world by balloon.</p>

<p>What is it that you feel deeply, intimately in moments like this?</p>

<hr />

<p><strong>07:37 - BP</strong></p>

<p><em>Sur le plan technique, vous êtes dans un ballon qui doit voler trois semaines. Vous ne savez pas si le ballon va voler aussi longtemps, si vous avez assez de réserves de gaz. Si le vent va vous pousser dans la bonne direction pendant ces trois semaines. Mais en même temps, ce qui est magnifique, c’est que vous êtes poussés par les forces de la nature. Il n’y a pas de moteur, il n’y a pas de gouvernail. Vous êtes poussés par le vent.</em></p>

<p>On a technical level, you are in a balloon that must fly three weeks. You don’t know if the balloon is going to fly that long, or if you have enough gas reserves remaining. If the wind is going to push you in the right direction during these three week as well. But at the same time, what is wonderful, is that you are pushed by the forces of nature. There is no motor, no rudder. You are propelled by the wind.</p>

<hr />

<p><strong>07:55 - BP</strong></p>

<p><em>Et puis, vous partez. Vous savez que vous avez 45 000 kilomètres en face de vous. Puis, peu à peu, vous arrivez à vous diriger et comment vous vous dirigez. Ce qui est extraordinaire, c’est que vous vous dirigez en changeant d’altitude parce que l’atmosphère est faite de couches météorologiques très différentes qui ont toutes une autre direction et une autre vitesse. Donc, si vous montez ou vous descendez, vous partez plus à gauche ou plus à droite et vous apprenez comme ça à utiliser ce changement d’altitude pour trouver la meilleure direction.</em></p>

<p>Then you depart. You know that you have 45 000 kilometers in front of you. Well, little by little, you begin to gain control of yourself and your direction. What’s extraordinary, is that you manage your direction by changing altitude because the atmosphère is made of very different weather layers that all have different directions and speeds. Therefore, if you ascend or descend, you move more to the left or more to the right and you learn how to use the changing of altitude to find the best direction.</p>

<hr />

<p><strong>08:22 - BP</strong></p>

<p><em>Et pour changer d’altitude, vous devez lâcher du lest, lâcher du poids. et finalement, c’est une métaphore de la vie. C’est pour ça que j’aime le ballon. Le ballon, ce n’est pas un sport. Pour moi, c’est une philosophie de vie. Parce que dans la vie, vous êtes aussi poussé par les vents de la vie, par tout ce que vous ne pouvez pas contrôler, tout ce qui arrive, qui est en dehors de votre volonté souvent. Et vous devez lâcher du lest de vos certitudes, de vos habitudes, de vos dogmes, de vos croyances, de manière à pouvoir changer d’altitude et capter d’autres influences, d’autres directions dans laquelle la vie vous poussera.</em></p>

<p>And to change the altitude, you need to let go of the ballast, to cast off the weight.  Finally, it’s a metaphor of life. It’s for this that I love the balloon. Ballooning is not a sport. For me, it’s a philosophy for life. Because in life, you are also pushed by the winds of life, all of which you cannot control, all of which arrive, which are outside of your will usually. And you need to let go of the ballast of your certainties, of your habits, of your dogmas, of your beliefs, in order to be able to change the attitude and pick up other influences, other directions in which life will push you.</p>

<hr />

<p><strong>09:05 - MT</strong></p>

<p><em>Et puis, en 2003, vous vous êtes lancé dans le nouveau grand projet de votre existence avec la construction de Solar Impulse. Cet avion solaire capable de voler jour et nuit sans carburant. C’est à son bord que vous avez fait le tour du monde, de mars 2015 à juillet 2016. En vous relayant avec le pilote André Borschberg. Que cherchiez vous alors à prouver à vous-même et au monde?</em></p>

<p>And then, in 2003, you throw yourself into the next big project of your life with the construction of Solar Impulse. That solar airplane capable of flying day and night without fuel. It’s on board that you made the world tour, from March 2015 to July 2016. You along with the pilot André Borschberg, what were you seeking to prove to yourself and to the world?</p>

<hr />

<p><strong>09:26 - BP</strong></p>

<p><em>Quand j’ai atterri avec « Breitling Orbiter 3 » après le tour du monde en ballon, il restait 40 kilos de gaz liquide sur les 3700 kilos du départ.</em></p>

<p>When I landed with Breitling Orbiter 3 after the world tour by balloon, It only had 40 kilos of liquid gas from the 3700 kilos on departure.</p>

<hr />

<p><strong>09:32 - MT</strong></p>

<p><em>Vous étiez vraiment sur le fil?</em></p>

<p>You were really on the edge?</p>

<hr />

<p><strong>09:34 - BP</strong></p>

<p><em>On était vraiment sur le fil.</em></p>

<p>Really on the edge.</p>

<hr />

<p><strong>09:36 - BP</strong></p>

<p><em>C’est là que j’ai vu que quand on dit : « le ciel est la limite », « the sky is the limit », ce n’est pas vrai, c’est le carburant qui est la limite. Vous ne pouvez juste pas aller plus loin.</em></p>

<p><em>Après trois semaines, il restait deux heures d’autonomie, et c’est là que j’ai commencé à rêver d’une possibilité de faire un tour du monde sans carburant et d’utiliser ça pour montrer ce qu’on peut faire en libérant du pétrole, ce qu’on peut faire avec des technologies propres, ce qu’on peut faire avec des énergies renouvables en termes d’exploits a priori impossibles. 
C’était ça qui me motivait alors dans Solar Impulse. Donc ce n’était pas de dire que tout le monde allait voler avec des avions solaires prochainement mais que cet avion pouvait être un messager, un ambassadeur des énergies renouvelables et montrer que si on pouvait le faire en vol, là où c’est le plus difficile, et bien forcément, on peut le faire au sol aussi.</em></p>

<p>It’s there that I saw that when they say ‘the sky that is the limit’ it’s not true.  It’s the fuel that is the limit.   You just can’t go further.
After 3 weeks, what remained was two hours of runnning. and it’s there that I started to dream of the possibility to make a world tour without fuel and using that to show what can be done free from petroleum.  What can be done with renewable energy and what  we can do with renewable energies in terms of a priori exploits.</p>

<p>It’s that which motivated me towards Solar Impulse at that time.  It wasn’t to claim that everybody is going to fly with solar airplanes soon, but that this airplane can be a messenger and an ambassador of renewable energy and show what can be done in flight where it’s more difficult so it can be done on the ground as well.</p>

<hr />

<p><strong>10:25 - MT</strong></p>

<p><em>Vous aviez eu peur pendant ce moment-là?</em></p>

<p>We’re you scared at that time?</p>

<hr />

<p><strong>10:26 - BP</strong></p>

<p><em>Je n’ai jamais eu peur en vol. Parce qu’en vol, on est tellement connecté à soi-même, on est dans un tel niveau de performance, de conscience qu’on a l’impression qu’on arrive à résoudre les différents problèmes.</em></p>

<p><em>Par contre, j’ai eu très souvent peur au sol, de ne pas pouvoir voler, de ne pas aboutir avec cette aventure, on était plusieurs fois à deux mois de la faillite parce que c’était quand-même une aventure où il fallait payer une centaine de personnes en moyenne tous les mois.</em></p>

<p><em>Donc il fallait des sponsors, des partenaires, pour que ça marche. Il fallait que l’avion vol bien, on avait des problèmes météo, des problèmes techniques, énormément de problèmes administratifs et bureaucratiques, terribles. Donc, tout ça c’était très lourd et je dois dire que c’était fatigant, c’était pénible. il fallait beaucoup de résilience, heureusement il y avait les moments de vol qui eux étaient extraordinaires.</em></p>

<p>I’ve never been scared in flight.  Because in flight, I am so connected to myself and am in such a level of peformance and awareness that I’m ready to resolve various problems.</p>

<p>On the other hand, I was often afraid on the ground, of not being able to fly, of not being able to complete this adventure.  There were several times we were two months  from bankruptcy because it was still an venture which needed to pay a hundred people on average each month.</p>

<p>Therefore we needed sponsors &amp; partners to proceed. We needed a plane that flies well.  There were weather problems, technical problems large administrative and bureaucratic problems.  Therefore it was all very onerous and I must say, it was tiring and painful.  It took a lot of resilience.  Fortunately, there were moments in my flight that were extraordinary.</p>

<hr />

<p><strong>11:15 - MT</strong></p>

<p><em>Vous pourriez nous raconter un petit peu ces moments-là?</em></p>

<p>Can you tell us a little bit about these moments?</p>

<hr />

<p><strong>11:18 - BP</strong></p>

<p><em>Vous êtes aligné sur une piste de décollage dans un aéroport, quel qu’il soit, en Chine, en Birmanie, aux États-Unis. Vous avez toute votre équipe autour de l’avion, les membres de l’équipe tiennent les ailes, vous avez une partie des ingénieurs à Monaco qui communiquent par téléphone satellite avec vous.</em></p>

<p><em>Vous êtes comme dans un lancement de fusée, pratiquement, et puis tout à coup, vous avez la tour de contrôle qui vous dit: « Solar Impulse 2 vous êtes autorisés au décollage ». Et là vous mettez des manettes des moteurs à fond, il n’y a pas bruit, un tout petit sifflement. Vous avez l’avion qui commence à avancer et au bout de 150 mètres vous êtes en l’air. Alors, ça ne monte pas comme une fusée, ca monte très doucement</em></p>

<p>You are lined up at any takeoff runway in China, Burma, US.  You have all your aircraft team around the plane. The members of the team hold the wings.  You have a party of engineers in monaco who communicate with you via satellite phone.</p>

<p>It’s like launching a rocket really. The suddenly you have the control tower which tells you: “Solar Impulse 2 that you are cleared to take-off”.  Then you apply the full throttle to the motors, there is no sound, just a small whistle. You have the plane beginning to advance until after 150m, you are in the air. So it doesn’t climb like a rocket, it climbs very slowly.</p>

<hr />

<p><strong>12:00 - BP</strong></p>

<p><em>Mais il n’y a pas bruit, il n’y a pas de carburant, il n’y a pas de pollution, et vous êtes dans un avion totalement unique au monde, et vous vous dites:</em></p>

<p><em>« Et bien voilà, j’ai décollé. Maintenant, j’ai l’Atlantique devant moi, j’ai le Pacifique devant moi, j’ai la Chine devant moi »;</em></p>

<p><em>que vous savez que vous allez rester en vol plusieurs jours et plusieurs nuits, et que vous êtes au milieu de l’inconnue, au milieu des doutes, au milieu de tas choses qui vont peut-être ne pas se passer comme vous voulez, et vous devez réussir. Moi, je me rappelle très bien quand j’ai laissé la cote de Hawaii derrière mois et que j’avais 4000 kilomètres d’eau jusqu’à San Francisco, c’est extraordinaire comme moment.</em></p>

<p>But there’s no noise and there’s no fuel and no pollution. You are in a plane that is totally unique in the world and you to yourself:</p>

<p>“Voila, I’ve launched.  Now, I have the Atlantic in front of me, I have the Pacific in front of me.  I have China in front of me.“</p>

<p>that you know that you are going to stay in flight many days and nights.  and you are in a milieu of thoughts, of doubts, of many things that may not happen the way you want and you must succeed. Me, I remember very well when I left the coast of Hawaii behind me and I had 4000 kms of water until San Francisco. It was an extraordinary moment.</p>

<hr />

<p><strong>12:38 - Reporter</strong></p>

<p><em>Dans le ciel, seules quelques lumières trouent l’obscurité. En silence, Solar Impulse 2 est apparu au-dessus de l’aéroport d’Abou Dabi. L’avion solaire, se pose très lentement. Sur le tarmac, André Borschberg accueille son coéquipier Bertrand Piccard, ils se congratulent. Leur pari insensé est gagné.</em></p>

<p>In the sky, just a few lights pierce the darkness.  In silence, Solar Impulse II appears over Abu Dhabi airort.  The solar plane lands very slowly. On the tarmac, Andre Bourgberg embraces his teammate Bertrand Piccard. The congratulate each other.  The insane bet is won.</p>

<hr />

<p><strong>13:04 - MT</strong></p>

<p><em>Je voudrais vous faire lire un petit passage d’une de vos citations qui résume votre conception enthousiaste et métaphysique de l’aventure</em></p>

<p><em>alors c’est celle-ci</em></p>

<p>I’d like you to read a small passage of one of your quotes that summarizes your enthusiastic and metaphysical concept of adventure.</p>

<p>This is it here</p>

<hr />

<p><strong>13:17 - BP</strong></p>

<p><em>L’aventure est un état d’esprit vis-à-vis de l’inconnu une façon de concevoir notre existence comme un chant expérimental dans lequel nous sommes obligés de développer une ressource intérieure, de gravir le chemin de l’évolution personnelle et d’assimiler les valeurs éthiques et spirituelles dont nous avons besoin comme compagnon de voyage.</em></p>

<p>Adventure is a spiritual state facing the unknown. A manner of conceiving our existence like an experimental song in which we are required to develop an interior resource, of climbing the path of personal evolution and of assimilating the ethics and spiritual values within that we need like a travelling companion.</p>

<hr />

<p><strong>13:44 - MT</strong></p>

<p><em>Est-ce que vous pourriez me dire un peu comment ont évolué, justement, ces ressources intérieures que vous avez su mobiliser depuis vos premières expériences de vol en delta-plane à aujourd’hui.</em></p>

<p>Could you tell me a bit on exactly how these interior resources that you have mobilized since your first experiences before with hang-gliding have evolved until today?</p>

<hr />

<p><strong>13:55 - BP</strong></p>

<p><em>Au début c’était le courage et c’est devenu la confiance. Le courage c’est quand vous arrivez à faire quelque chose même si vous avez peur. Mais ce n’est pas suffisant. Moi ce que je remarque, c’est que ce qui important c’est la confiance. Et c’est ce que j’ai prouvé quand j’étais avec Breitling Orbiter 3, entre terre et ciel, avec Solar Impulse 2, au milieu d’un océan, vous êtes tout seul, vous êtes là, même de nuit, à des milliers de kilomètres de toute possibilité de secours et vous vous sentez mieux que dans tous les moments de votre vie normale.</em></p>

<p>First, it was the courage and then came the confidence.  The courage is when you will proceed to do something even if you are scared.  But that’s not enough.  What I noticed, is that what matters is confidence and that’s what I proved when I with Brietling Orbiter 3, between earth and sky, and with Solar Impulse 2.  Within the vastness of the ocean, you are all alone, even at night and thousands of kilometers away from all possibilities of relief and you feel better than at any time in your normal life.</p>

<hr />

<p><strong>14:28 - BP</strong></p>

<p><em>Et ça au début, c’était vraiment un point d’interrogation, je me disais, mais comment c’est possible, je suis complètement fou, je suis dans une situation qui empêcherait tout le monde de dormir et moi je me sent mieux que dans n’importe quel moment de ma vie. 
Et en fait, je crois que c’est vraiment le fait que quand on se met en rupture par rapport à toutes nos habitudes tout notre conditionnement qu’on est catapulté en dehors de sa zone de confort en est obligé de se retrouver à l’intérieur de soi-même et d’aller puiser les ressources qu’il vous faut au fond de soi-même. Et quand vous trouvez les ressources qu’il vous faut en vous, ça donne une confiance immense dans l’être humain, dans la vie, dans le monde, dans tout ce qui nous guide, parce qu’on voit qu’on a en soi ce qu’il faut pour avancer.</em></p>

<p>And at the beginning, it was really a question mark.  I was telling myself, but how is it possible, I’m completely crazy.  I am in a situation that would prevent everyone from sleeping and I feel better than any time in my life. 
In effect, I believe that it’s really the fact that when we break from all our conditioning, that we are catapulted out of our comfort zone, we are forced to find our true selves and when we find the resources that we need within ourselves, it gives an immense confidence in humanity; in life; in the world; in all that guides us because we see in ourselves everything that is needed to move forward.</p>

<hr />

<p><strong>15:10 - MT</strong></p>

<p><em>Mais est-ce que vous appréhendez les atterrissages, la manière de se réacclimater au monde au sol</em></p>

<p>But do you prepared yourself for the landing, the way to reacclimatize to the world on the ground?</p>

<hr />

<p><strong>15:15 - BP</strong></p>

<p><em>L’avantage c’est que quand vous êtes vraiment dans ces moments de grâce, quand vous voyez à quel point vous pouvez fonctionner mieux que d’habitude, quand vous revenez dans la vie normale, la vie n’est plus totalement normale. Vous arrivez à en extraire beaucoup plus de l’essentiel. Vous arrivez à donner beaucoup plus de valeur aux relations humaines, au destin, à la spiritualité, à tous les événements de la vie. Vous voyez qu’en fait l’aventure elle n’est pas que « en l’air », l’aventure elle est aussi au sol. Elle est dans votre vie de tous les jours dans tout ce qui guide vos pas à la recherche de ce que vous cherchez.</em></p>

<p>The great thing is that when you are really in these moments of grace, when you see at what point you can function better than usual. When you return to normal life, life is no longer completely normal. You come to get a lot more out of the essentials. You come to place a lot more value on human relationships, to fate, to spirituality, to all the stages in life.  You see that in fact the deventure is not just in the air.  The adventure is also on the ground.  It is in your everyday life and in everything that guides you towards what you are seeking.</p>

<hr />

<p><strong>16:04 - MT</strong></p>

<p><em>Une autre facette de votre vie que nous n’avons pas encore explorée, mais vous avez donc décidé de faire des études de médecine avec une double spécialisation en psychiatrie et psychothérapie, qu’est-ce que vous avez tiré de tous ces apprentissages sur les mondes intérieurs?</em></p>

<p>Another aspect of your life that we haven’t already explored, you have done decided to study medicine with a double specialization in psychiatry and psychotherapy.  What have you pulled from all these studies about the interior world?</p>

<hr />

<p><strong>16:18 - BP</strong></p>

<p><em>J’ai vu à quel point les gens souffrent et se sentent mal dans leur vie. Au moment où ils oublient leur racine spirituelle, au moment où ils ont perdu le sens du contexte dans lequel ils vivent. Beaucoup de gens veulent se rassurer avec des repères extérieurs, très matériels, s’appuient sur des gens qu’ils aiment mais qui peuvent mourir, sur de l’argent qui peut disparaître, et finalement je pense qu’il y a énormément de gens qui sont angoissés parce qu’ils vivent en équilibre instable sur des repères qui peuvent s’effondrer à n’importe quel moment.</em></p>

<p>I saw to what point people suffer and feel bad in their lives. At the time they forget their spiritual roots. At the moment where they have lost the sense of context in which they live.  Many people want to comfort themselves with external, very material fixes/benchmarks.  To rely on people they love but who can die or over money which can disappear. Finally I think that there are many people who are disoriented because they live in unstable equilibrium based on landmarks that could collapse at any time.</p>

<hr />

<p><strong>17:00 - BP</strong></p>

<p><em>Ce qui est fondamental, c’est de développer le sens de l’essentiel. C’est à dire Revenir à pourquoi on vit, et se dire que peut-être qu’on vient de quelque part, mais on ne sait pas où. On va quelque part, et on ne sait pas où. On ne sait pas très bien pourquoi on est là. Et au lieu d’avoir des réponses toutes faites, on peut se permettre d’avoir des questions ouvertes. Et quand on a des questions ouvertes, on devient un explorateur.</em></p>

<p>What’s fundamental, is to develop a sence of the essential. I mean to return to the why of life and say to ourselves that maybe we come from somewhere, but we don’t know where.  We are going somewhere, but we don’t know where We don’t really know why we are here.  So instead of having answers for everything, we can allow for open questions. and when you have open questions, you become an explorer.</p>

<hr />

<p><strong>17:24 - MT</strong></p>

<p><em>Mais est-ce que ce n’est pas épuisant d’être sans cesse dans ce mouvement de renouvellement, de grand questionnement existentiel?</em></p>

<p>But isn’t it exhausting to be constantly in this movement of renewal? Of great existential questioning?</p>

<hr />

<p><strong>17:29 - BP</strong></p>

<p><em>Alors, moi je trouve que c’est ça qui nourrit, c’est ça qui donne l’énergie. Ce qui est épuisant c’est l’équilibre instable, se disant je ne sais pas pourquoi je vis, je ne sais pas ce que je fais là, mais il faut que je sois le plus heureux possible. Puis ensuite on fait comment pour être le plus heureux possible?</em></p>

<p><em>Alors, on essaie d’acquérir des biens matériels, d’être amoureux de quelqu’un qui n’est peut-être pas amoureux de vous. Enfin, il y a plein de choses qui ne dépendent plus de nous, alors que notre sécurité intérieure et notre quête, elles dépendent de nous. Et ça recadre complètement les événements qui arrivent.</em></p>

<p><em>Les événements de la vie ne sont peut-être pas là pour vous détruire, les événements de la vie sont peut-être là pour vous stimuler à lâcher des certitudes, lâcher des habitudes, lâcher des croyances, vous ouvrir à d’autres dimensions et trouver d’autres influences qui vont vous emmener dans d’autres directions de votre vie.</em></p>

<p>Actually, I find that it’s what nourishes.  It’s that which gives the energy.  What is exhausting, is the unstable equilibrium.  If I don’t know why I’m alive, I don’t know what I’m doing here. But I should be as happy as possible.  So what can be done to be as happy as possible?</p>

<p>So we try to acquire material goods, to be in love with someone who is not in love with you. Finally, there are plenty of things that don’t depend on us anymore.  And they completely reframe the events that come along.</p>

<p>Maybe life events don’t happen to destroy you.  Maybe life events happen to stimulate you to release the certainties, to release the habits, release the beliefs, to open up other dimensions and find influences that will take your life in new directions.</p>

<hr />

<p><strong>18:16 - MT</strong></p>

<p><em>Et vous trouvez que la société est réceptive à ce discours-là ? On voit qu’il y a un changement de paradigme et une prise de conscience de ça aujourd’hui?</em></p>

<p>And do you find that society is receptive to this discours? Does there appear to be a paradigm shift and consciousness like that today?</p>

<hr />

<p><strong>18:22 - BP</strong></p>

<p><em>Moi j’ai toujours observé que l’évolution elle se faisait beaucoup plus à titre individuel que collectivement. Je n’ai pas l’impression que c’est la société qui évolue dans cette direction-là. Ce sont les individus isolément qui tout à coup trouvent quelque chose là-dedans qui leur permet d’avancer. On ne vit pas dans une société qui s’intéresse à l’essentiel.</em></p>

<p>Me, I have always observed that the evolution more individually than collectively.  I don’t have the impression that society is developing in this direction. It’s these isolated individuals who have suddenly found something that gives them the ability to advance.  We don’t live in a society that is interested in the essentials.</p>

<hr />

<p><strong>18:50 - MT</strong></p>

<p><em>Vous l’avez brièvement évoqué tout à l’heure, mais vous avez grandi dans une famille aussi très portée sur la spiritualité avec une grand-mère maternelle pasteure. Votre mère aussi qui vous a fait part de ses études sur le bouddhisme sur le taoïsme. Comment est-ce que ça a nourri votre parcours?</em></p>

<p>You briefly mentioned it earlier. But you grew up in a family that was very spiritual with a maternal grandmother who was a pastor. Your mother as well who imparted you with her studies of buddhism and Taoism.  How has this nourished your journey?</p>

<hr />

<p><strong>19:04 - BP</strong></p>

<p><em>C’est un aspect fondamental, et d’habitude, tout le monde me parle de mon père et de mon grand-père, qui sont des explorateurs qui ont apporté énormément au 20ème siècle, mais c’est vrai qu’avoir une mère qui vous prend au sérieux comme enfant, dans votre recherche de compréhension de la vie, de la mort, de Dieu, des autres, c’est extraordinaire.</em></p>

<p><em>J’ai passé des heures et des heures à me promener avec ma mère dans la forêt, dans la montagne, un peu partout, déjà quand j’avais 6 ans, 7 ans, et puis je lui posais toutes les questions que je pouvais pour essayer de comprendre pourquoi j’étais là, à quoi ça sert tout ce qu’on fait, tout ce qu’on voit, on vient d’où, on va où, et cetera.</em></p>

<p><em>Puis elle m’expliquait tout ce qu’elle avait compris dans toutes ses recherches. Que ce soit dans le christianisme, dans le bouddhisme, dans l’hindouisme, dans tous les groupes de développement personnel, et cetera. Et puis de temps en temps elle me disait : « ha bah ça, je ne sais pas ». Mais c’est extraordinaire comme cadeau quand un adulte dit à un enfant : « je ne sais pas ».</em></p>

<p>It’s a fundamental aspect and usually everyone talks to me about my father and grandfather, who were explorers that contributed alot to the 20th century. But it’s really my mother who  takes you seriously as a child in attempting to understand life, death, God, others. It’s extraordinary.</p>

<p>I spent hours and hours walking with my mother in the forest, in the mountains everywhere. Already when I was 6 to 7 years old, I would ask all these questions that I could. Trying To try and understand why I was there, what is the point of everything we do, everything we see, we come from where, we go where, etc.</p>

<p>Then she explained to me all that she understood from her research.  Whether in Christianity, in Buddhism, in Hinduism in different personal development groups. And sometimes she would say to me: “I don’t know”. But it’s an amazing gift to a child when an adult says: “I don’t know”.</p>

<hr />

<p><strong>20:02 - MT</strong></p>

<p><em>Oui, l’honnêteté de savoir avouer ses limites aussi.</em></p>

<p>Yes, the honesty of knowing how to admit your limits as well</p>

<hr />

<p><strong>20:06 - BP</strong></p>

<p><em>Mais totalement, l’honnêteté absolue et puis en plus la stimulation pour l’enfant de se dire : « Mes parents ne savent pas, mais moi je vais peut-être essayer de comprendre et essayer de trouver. » Donc ça donne envie d’aller plus loin, ce ne sont plus seulement des questions, ça devient une quête. Alors j’avais la quête de comprendre le monde intérieur avec ma mère, de comprendre le monde extérieur avec mon père, et c’est en fait la synthèse des deux qui m’a animé toute ma vie.</em></p>

<p>Ya totally, absolute honesty and then on top of that the stimulation for the child. To say to themself, “My parents don’t know but me i’m going to try to understand and try to find out”.  It’s more than just questions now. It has become a quest.  So I had the quest to understand the interior world with my mother and the exterior world with my father.  and it is really the synthesis of both that has animated me all my life.</p>

<hr />

<p><strong>20:28 - MT</strong></p>

<p><em>On comprend pourquoi vous êtes aussi, comme un équilibriste, toujours entre ces deux grands domaines de recherche. Vous-même, est-ce qu’aujourd’hui vous vous définiriez comme croyant, je crois que vous avez éduqué vos filles dans la religion catholique.</em></p>

<p>We understanding why you are also, like a balancing artist, always in between these two great areas of research.  You are, today, what you would define as a believer.  I believe that you have educated your daughter in the Catholic religion.</p>

<hr />

<p><strong>20:40 - BP</strong></p>

<p><em>Oui, alors croyant, cela dépend en quoi. Moi, je ne crois pas dans le dieu que les hommes ont fabriqué pour se rassurer de leur peur de la mort. Par contre, je crois en un dieu qui a créé l’être humain. Et qui, pour une raison qu’on ne connait pas très bien, a manifesté toute cette création, je pense qu’il y a un créateur à tout ça, je pense qu’il y a quelque chose qui donne un sens.</em></p>

<p><em>Donc ce qui m’intéresse le plus c’est la notion de transcendance. C’est la notion d’une force supérieure, d’une énergie supérieure qui donne un sens à ce qu’on vit. Mais effectivement, on ne le comprend pas parce qu’on n’est pas à ce niveau, et je pense que l’être humain ne peux pas mettre un visage à Dieu, attribuer des émotions ou des volontés à Dieu, c’est horriblement présomptueux et arrogant de dire Dieu est comme si, Dieu est comme ça. On n’en sait rien, on doit être Dieu pour comprendre Dieu. C’est déjà difficile de connaître les hommes quand on est homme. Donc vous voyez…</em></p>

<p>Yes, on believing, it depends on what.  Me, I don’t believe in the God that people have fabricated in order to reassure themselves about their fear of death.  On the contrary, I believe in one God who created the human being.  Who, for some reason that we don’t understand well, manifested all of creation.  I believe that there is a creator behind it all. I think there’s something that makes sense.</p>

<p>Therefore what interests me most is the notion of transcendence.  It’s the notion of a higher force, a higher energy that gives a meaning to what we experience as life. But effectively, it’s incomprehensible because it’s on a different level and I think that humans cannot put a face to God, attribute emotions or wills to God, It’s horribly presumptuous and arrogant to say God is like this or God is like that. It’s already hard to understand people when you are a person. So you see…</p>

<hr />

<p><strong>21:44 - MT</strong></p>

<p><em>L’an dernier, vous avez aussi rencontré le pape François au Vatican. Est-ce que vous pourriez nous raconter cette rencontre?</em></p>

<p>Last year you also met Pope Francis at the Vatican.  Could you tell us about that meeting?</p>

<hr />

<p><strong>21:50 - BP</strong></p>

<p><em>Moi j’avais envie de rencontrer le pape François parce que… en fait c’est le premier pape que j’avais envie de rencontrer. Parce que j’ai l’impression que c’est le premier que s’est vraiment occupé des grands problèmes de notre monde : la pauvreté, l’environnement, le respect entre les êtres humains ; et qui essaie d’améliorer la qualité de vie sur Terre, indépendamment de toute politique.
Et puis j’avais lu le « laudato si » qui est cette encyclique sur l’environnement. Et j’avais envie de lui en parler parce qu’en fait, ce « laudato si », il très intéressant pour ceux qui arrivent à le compredre. Mais quand on parle essentiellement de respect pour l’environnement, d’amour pour le prochain et de reconnaissance pour la création divine, on va toucher une certaine partie des gens et ceux qu’on touche ne sont pas ceux qui détruisent l’environnement.</em></p>

<p>I wanted to meet with Pope Francis because, actually he is the first Pope I wanted to meet.  Because I have the impression that he’s the first who is really occupied with the great problems of our world like poverty, environment, respect between people; and who is trying to improve the quality of life on Earth independently of politics.
And then I read the Laudato Si which is the encyclical about the environment. and I had wanted to talk because really that Laudato Si is very interesting for those who manage to understand it.  But when we mainly speak about respect for the environment, love for thy neighbour and gratitude for divine creation, it will touch a certain group of people and those it touches are not those who destroy the environment.</p>

<hr />

<p><strong>22:35 - BP</strong></p>

<p><em>Ce n’est pas ceux qui tuent, torturent et massacrent leurs semblables.  Par conséquent, j’avais envie de lui dire, mais quel est la language qu’il faut pour convaincre ceux qui ne sont pas encore convaincus. Et moi j’avais envie d’aborder avec lui ce… C’est de ça qu’on a parlé, de toutes les solutions technologiques qui sont financièrement rentables et qui peuvent protéger l’environnement. Même quand on est égoïste, même quand on n’est pas spirituel ou religieux, même quand on a aucun respect pour les autres, mais peut-être qu’on peut faire du bien quand même parce qu’on y trouve un avantage soi-même.</em></p>

<p>It’s not those who kill, torture and massacre their fellow human beings. That’s why I had wanted to speak with him but what is the language that can convince those who aren’t already convinced? I wanted to approach this with him. That’s what we talked about, all of these technological solutions that are financially profitable and can protect the environment.  Even when you are selfish, even when you are not spiritual or religious even if you have no respect for others but maybe you can still do good because there is an advantage for your own self.</p>

<hr />

<p><strong>23:10 - MT</strong></p>

<p><em>Vous pensez la technologie pourrait sauver le monde?</em></p>

<p>Do you think technology can save the world?</p>

<hr />

<p><strong>23:13 - BP</strong></p>

<p><em>La technologie, ça dépend ce qu’on en fait. On peut détruire le monde avec la technologie, on peut sauver le monde avec la technologie. Mais aujourd’hui, c’est clair qu’il y a des technologies propres qui permettent à l’être humain d’être beaucoup plus efficient, d’économiser de l’énergie, d’économiser des ressources naturelles, économiser de la nourriture, valoriser les déchets, fonctionner nettement mieux et aujourd’hui vous avez en tout cas la moitié du problème qui resolvable totalement grâce à la technologie : technologies propres et énergies renouvelables. 
L’autre moitié nécessitera forcément des aménagements économiques, des aménagements d’attitude, de comportement humain, mais il ne faut pas commencer par le comportement humain, parce que si vous dites aux gens de faire des sacrifices, ils vont prendre l’écologie en grippe. Si vous leur dites, vous pouvez continuer à faire la même chose mais vous pouvez avoir un impact divisé par dix sur l’environnement parce que vous serez plus efficients, les technologies modernes vous permettront de protéger l’environnement. Et bien ils vont adorer l’écologie. Par conséquent, il faut commencer par faire tout ce qu’on peut sur le plan technologique, et puis ensuite, si on doit aller plus loin, à ce moment-là, on peut peut-être demander aux gens de changer les attitudes.</em></p>

<p>Technology depends on how it is used.  We can destroy the world with technology and we can save the world with technology.  But today it’s clear that there is the right technology to permit humanity to be a lot more efficient. More energy efficiency, efficiency of natural resources, food efficiency and increasing the value of waste that function better and today you have in any cases half of the problems that can be solved thanks to technology: Clean technology and renewable energy.<br />
The other half requires economic adjustments, as well as adjustment to attitudes and human behaviours. But it shouldn’t start with human behaviour because when you are asking people to make sacrifices.  They are going to take ecology into consideration.  If you tell them, you  can continue doing the same thing but you can have 10% of the environmental impact because you are more efficient, modern technologies permit you to protect the environment. Then they are going to love the ecology. Therefore we should start by doing everything we can with technology. Then if we must go further, perhaps we can people to change their attitudes.</p>

<hr />

<p><strong>24:20 - MT</strong></p>

<p><em>Et le pape François été réceptif à votre discours pendant votre rencontre?</em></p>

<p>And Pope Francis was receptive to your speech during your meeting?</p>

<hr />

<p><strong>24:24 - BP</strong></p>

<p><em>On a dit qu’on allait se revoir, mais c’était un mois avant le début de la pandémie quand je l’ai rencontré. Donc c’est vrai qu’on n’a pas pu se revoir. On a gardé des contacts épistolaires, notamment avec le cardinal Turkson qui dirige cette partie-là du Vatican. Je me réjouis de pouvoir aller lui amener les milles solutions rentables pour protéger l’environnement que la fondation Solar Impulse saura trouver d’ici le mois d’avril et de pouvoir lui montrer qu’il y a énormément de technologies qui peuvent motiver, dans la protection de l’environnement, ceux qui ne sont pas sensibles à son « laudato si ».</em></p>

<p>We said that we would meet again. But it was a month before the start of the epidemic when we met. So really we haven’t had the chance to meet again.  We’ve kept in written contact, especially with Cardinal Turkson who directs that part of the Vatican.  I’m thrilled to be able to bring him the 1000 profitable solutions to protect the environment that the Solar Impulse Foundation will be able to find by April and to be able to show him that there are many technologies that can motivate, towards protection of the environment, those who are not sensitive to his Laudato Si.</p>

<hr />

<p><strong>24:58 - MT</strong></p>

<p><em>Comment est-ce que vous vous situez par rapport à une certaine écologie catastrophiste et millénariste?</em></p>

<p>How do you position yourself in relation to a certain catastrophist and millenarian ecology.</p>

<hr />

<p><strong>25:05 - BP</strong></p>

<p><em>Pour que les gens adoptent de nouvelles solutions, adoptent de nouvelles technologies, passent du pétrole au solaire, passent du chauffage inefficient à la pompe à chaleur, passent d’une voiture diesel à une voiture électrique. En fait, il faut un choc, parce que sinon, il n’y a pas grand monde qui a l’esprit de pionnier et qui est intéressé spontanément par le changement. Et ce choc, les écologistes le donnent, les catastrophistes le donnent, Greta Thunnberg le donne, et c’est bien, parce qu’il faut que les gens voient que s’ils ne font rien, on court tous à la catastrophe. Et la catastrophe va venir beaucoup plus vite qu’on ne le croit et de manière beaucoup plus grave qu’on ne le croit.</em></p>

<p><em>Par contre, il y a des solutions pour éviter cette catastrophe. Et si on a peur de la catastrophe, on va se mobiliser beaucoup plus pour utiliser des solutions et changer le cours des choses.</em></p>

<p>For people to adopt new solutions, adopt new technologies, switch from petrol to solar, switch from inefficient heating to heat pumps switch from a diesel car to an electric.  In fact, requires a shock.  Because otherwise not many people are pioneering and spontaneously interested in changing.  It’s this shock the ecologists give, that the catastrophits give, that Greta Thornburg gives. It’s good because people have to see that if they do nothing, everyone is headed for a disaster and the disaster will come a lot more quickly and seriously than most believe.</p>

<p>On the other hand, there are solutions for avoiding the catastrophe.  If we are afraid of the catastrophes, and if we are afraid of the disaster, we will mobilize much more to use these solutions to change the course of things</p>

<hr />

<p><strong>25:58 - MT</strong></p>

<p><em>Vous venez d’écouter un épisode de la troisième saison de « Place des Religions ». S’il vous a intéressé, n’hésitez pas à le partager et à vous abonner à notre podcast. « Place des Religions » est à écouter sur toutes les plateformes, sur le site et l’appli « La Croix ».</em></p>

<p>You have just listened to an episode of the third season of “Place des Religions”. If it interested you, feel free to share it and subscribe to our podcast. “Place des Religions” can be listened to on all platforms, on the “La Croix” website and app.</p>

<p><em>Photo Credit: <a href="houseofswitzerland.org/sites/default/files/story/gallery/2014_10_28_18th_Flight_Pizzolante_Solar_Impulse_2_8_web.jpg">houseofswitzerland.org</a></em></p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="solar-impulse" /><summary type="html"><![CDATA[In April, Capt Piccard sat down with the Malo Tresca and the podcast Place des Religions for a discussion about exploration, consciousness and how the Solar Impulse Network of 1000 Solutions can contribute to the great existential challenge of the 21st century. I decided to do a translation into English. I opted to do this for a few reasons: Just for fun and French practice To reflect more on where Solar Impulse might be heading with its newest initiative and tagline Ecology as driving force for economy I really want to see this initiative succeed]]></summary></entry><entry><title type="html">sunE declares intention to achieve Net-Zero across its supply chain by 2025.</title><link href="https://sunetrike.com/announcements/declaration-to-achieve-net-zero/" rel="alternate" type="text/html" title="sunE declares intention to achieve Net-Zero across its supply chain by 2025." /><published>2021-08-24T01:08:07+08:00</published><updated>2021-08-24T01:08:07+08:00</updated><id>https://sunetrike.com/announcements/declaration-to-achieve-net-zero</id><content type="html" xml:base="https://sunetrike.com/announcements/declaration-to-achieve-net-zero/"><![CDATA[<p>We are pleased to announce a minor (but important) change in compass-heading for the sunE Venture.  Please see our declaration to achieve net-zero <a href="/sunE-net-zero-declaration/">here</a></p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="announcements" /><summary type="html"><![CDATA[We are pleased to announce a minor (but important) change in compass-heading for the sunE Venture. Please see our declaration to achieve net-zero here]]></summary></entry><entry><title type="html">Past, Present and Future of Environmentalism - Presentation for Mapua’s Social Sciences and Education week</title><link href="https://sunetrike.com/presentations/environmentalism/mapua-humanities-presentation-environmentalism-past-present-future/" rel="alternate" type="text/html" title="Past, Present and Future of Environmentalism - Presentation for Mapua’s Social Sciences and Education week" /><published>2021-06-26T01:08:07+08:00</published><updated>2021-06-26T01:08:07+08:00</updated><id>https://sunetrike.com/presentations/environmentalism/mapua-humanities-presentation-environmentalism-past-present-future</id><content type="html" xml:base="https://sunetrike.com/presentations/environmentalism/mapua-humanities-presentation-environmentalism-past-present-future/"><![CDATA[<p>As part the week in Social Sciences and Education at <a href="ssse.mapua.edu.ph">Mapua University</a>, I was grateful for the opportunity to share my thoughts about environmentalism with some of the bright, emerging minds of the Philippines.</p>

<object data="/assets/pdfs/mapua-ssed-presentation.pdf" width="600" height="400" type="application/pdf">
  <p>It appears as though your browser doesn't have a PDF plugin.

  	<h3>It is available for Download here:</h3> 
  	<a href="/assets/pdfs/mapua-ssed-presentation.pdf">Past, Present and Future for Environmentalism</a>
  </p>
</object>

<p>I attempted to share what I felt was a good cross-section of links and references which represent the evolution of my own views since <a href="https://apps.ualberta.ca/catalogue/course/ren_r/260">taking a similar course</a> during my own time spent in university.  I suspect more robust references could be found within the walls of academia.</p>

<p>My hope is that what I shared will help give some students ideas on how to forge their own path in the world and find the courage to pursue their passion in a field as dynamic and complex as environmental sustainability.</p>

<p>Readers are asked to please be mindful that the contents of this presentation were delivered with an addtional oral explanation so there is potential to misinterpret the statements.</p>

<p>I welcome respectful discussion on this and I recognize that some of the topics discussed inside may have alterantive explanations that are also valid.  Meanwhile I will also contend that there are plenty of messages and opinions that we (humanity) have adopted which give a comfortable position from which to continue our destructive tendencies.</p>

<p>Progress has been made, but we still have lots of work ahead of us.</p>

<p>Opinions expressed in this presentation should not be considered as representative of the broader sunE team.</p>

<p><img src="/assets/images/mapua/mapua-ssed-poster.jpeg" alt="Social Sciences and Eduation - Mapua" /></p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="presentations" /><category term="environmentalism" /><summary type="html"><![CDATA[As part the week in Social Sciences and Education at Mapua University, I was grateful for the opportunity to share my thoughts about environmentalism with some of the bright, emerging minds of the Philippines. It appears as though your browser doesn't have a PDF plugin. It is available for Download here: Past, Present and Future for Environmentalism]]></summary></entry><entry><title type="html">My Pedal Powered Adventure - An hommage to Piccard’s Epic Voyage</title><link href="https://sunetrike.com/solar-impulse/my-pedal-powered-journey/" rel="alternate" type="text/html" title="My Pedal Powered Adventure - An hommage to Piccard’s Epic Voyage" /><published>2021-04-12T01:08:07+08:00</published><updated>2021-04-12T01:08:07+08:00</updated><id>https://sunetrike.com/solar-impulse/my-pedal-powered-journey</id><content type="html" xml:base="https://sunetrike.com/solar-impulse/my-pedal-powered-journey/"><![CDATA[<p>In a salute to the <a href="https://solarimpulse.com/beyond-1000-solutions">1000 solution milestone</a> of the Solar Impulse Foundation, This story is a bit of an hommage to the immensely inspiring 2010 TED talk by Captain Bertrand Piccard titled <a href="https://www.ted.com/talks/bertrand_piccard_my_solar_powered_adventure#t-1046442">‘My Solar-Powered Adventure’</a>.</p>

<p>This entrepreneurship adventure of ours has had many highs and lows.  His speech has pulled me out of the depths of despair on more than one occasion.  What a great gift to humanity he has given by providing a living embodiment for the <a href="/assets/images/pedal-power/next_generation.jpg">Next Generation</a> to tackle one of the biggest challenges of our time.  The team at sunE couldn’t be prouder to have been accepted onto this ship.</p>

<h2 id="so-without-further-ado-onto-the-story">So without further ado, onto the story</h2>

<p>The year is 2011, I had just won best presentation award at the 1st Student Research Symposium of the <a href="http://www.helmholtz-alberta.org/?page_id=109">Helmholtz Alberta Initiative</a>.  As the only undergaduate to participate in the event, how exciting it was to be recognized by such accomplished academics for my efforts in trying to understand the nature of the energy tucked away deep below our feet.  I asked of one of these men, the head of an experimental forest in Germany, what is my next step?  His answer was simple:
	<img src="/assets/images/pedal-power/science_handout.jpg" alt="Just put your hand out" />
	“Just put your hand out.”</p>

<p>This wasn’t the answer I was looking for.  During my studies, I had formed the opinion that if we are going to solve climate change, it will be because we figured out how to make the business work.  Besides, I’d just graduated and spent the last couple months touring around southern British Columbia with one of my best buds Frankie (a master baker, painter and one of the most wonderfully caring souls you’ll ever meet).  I was in adventure mode and keen to bike down to the <a href="https://www.icenews.is/2011/10/23/geothermal-energy-conference-to-see-participation-from-islandsbanki/">Geothermal Resources Convention</a> in California.  With all the volcanoes along the way, I was super excited about all the new things I would discover.</p>

<p>I had stars in my eyes, I was on cloud-9.  Before I left, I stopped in to see my buddy Frankie, he was not looking so good.  Now that summer was over, he didn’t know how we was gonna make ends meet and didn’t know who to turn to.  He asked for help.</p>

<p>Here I was, on one side, being given the opportunity to write my dream ticket.  On the other side, with a close friend desperately seeking a hand which I had no idea how to give.  But my bags were packed, I was hitting the road.  I cut the ballast, so to speak.</p>

<p>So I picked up a ‘commuter’ bike (I was on my way to find a job after all) and a bit of camping gear from Lethbridge, Alberta and hit the road.
This is the picture of my border crossing.  Of course, in earlier times, there was no border and this was known simply as Blackfoot territory.  But I was happy to give a salute to all 3 nations represented at the border that day.</p>

<p><img src="/assets/images/pedal-power/border.jpg" alt="Montana border crossing" /></p>

<p>The leaves and huckleberry pies of Montana in the autumn are a special treat that few know about.  The mountains aren’t as jagged as the peaks to the north in Canada, but the rivers wind through those valleys like the crispest ribbons of silk.</p>

<p>Less than an hour across the border, BEAR!  BIG F-ING BEAR!  Biggest bloody grizzly bear I’ve ever seen in my life.  Bigger than most pickup trucks, I’m pretty sure with its paws stretched out, it would have spanned the entire 2-lane highway.  Less than 100 meters in front of me and my little commuter. This picture is not the actual bear by the way, I just found it on the internet.</p>

<p><img src="/assets/images/pedal-power/grizzly.jpg" alt="BIG F-ING BEAR!" /></p>

<p>Now I grew up in <a href="http://www.climatehotmap.org/global-warming-locations/british-columbia-canada.html">Prince George</a> and I’ve seen some big grizzly bears before.  But this was something else.  I didn’t even know they could get that big!!  But he didn’t stop, so he was gone as quickly as he appeared.</p>

<p>On I went, into the Snake River Plane..volcano and ice cave territory.  I came upon a geology book with a fascinating theory.  That around 17 million years ago a meteor hit the crust so hard, that it cracked right down to the mantle and up came the volcanic hotspot we now know today as Yellowstone. 
Around the same time, Nevada stared stretching apart like a piece of taffy.  This created all sorts of volcanic goodies like hot springs, geothermal reservoirs and lithium deposits (a bit of gold and copper as well, if you’re into that sort of thing).</p>

<p><img src="/assets/images/pedal-power/nevada_rifting.png" alt="Nevada Rifting!" /></p>

<p>From what I can tell, that particular theory didn’t really <a href="https://www.latimes.com/archives/la-xpm-1990-03-19-me-477-story.html">gain acceptance</a> within the academic community to date.  I’m sure many alternate explanations are also very compelling, but that one has always stuck with me.</p>

<p>Northern Nevada is a pretty rugged place.  Some like to joke that the only water around is boiling hot. It’s also a place for treasure hunters.  Probably one of the reasons the casinos felt so at home in the early days.</p>

<p>One morning, after a night spent befriending a group of local bikers at Farpoint Station, I heard them calling out to me.  They were worried but relieved when I came from my camp.  They showed me all of the fresh mountain lion tracks around my bicycle.</p>

<p><img src="/assets/images/pedal-power/cougar_paw.jpg" alt="My, what big claws you have!" /></p>

<p>From that day on, I slept wearing my bike helmet, with bike chain around my neck, and buck knife in hand. Thankfully, I made it into California with no more feline encounters and time to spare.  I even got to hop in some top-notch natural hotsprings.</p>

<p><img src="/assets/images/pedal-power/hot_spring.jpg" alt="Best bath ever!" /></p>

<p>Sadly, at the conference, pretty much everyone told me that I would need to go back to school to find a way into that industry.  I suppose that made sense.  But while speaking to the director of a major power company, I also received what I would now consider my first piece of executive advice:</p>

<p><strong><em>“Don’t feel bad being a big fish in a small pond”.</em></strong></p>

<p>My thesis mentor, Jacek also came out.  He told me about the great priviledge that comes from the attaining of a PhD and that I would probably benefit from the stability that universities can provide.</p>

<p><img src="/assets/images/pedal-power/jacek.jpg" alt="me n Jacek" /></p>

<p>So then the trip was over, even if I wasn’t going to have my big break into the clean energy industry just yet, I was still supercharged from the experience and I was sure I would do it…somehow.</p>

<p>On the flight back to Canada, I got a phone call.  Frankie was dead… Just like that, my world changed.  For all of the potential that I could look forward to, I had failed one of my closest friends.</p>

<p><img src="/assets/images/pedal-power/frankie.jpg" alt="Frankie" /></p>

<p>Suicide is a complex issue at the best of times.  Everybody will have their thoughts about what could have been done.  Family &amp; friends will each have different memories. Warning signs. Silent cries for help. 
“Oh, what I would have done if only I’d known.”</p>

<p>In my case, there cry for help was not silent.  It was the last conversation that I had with him.  I chose not to act and I will carry that with me for the rest of my life.</p>

<p><strong><em>“This achieving the centre - being grounded in one’s self - is about the highest state a human being can achieve” - Bruce Lee</em></strong></p>

<p>When we decided to move to the Philippines to start sunE, it was a near-instant decision and we really dived in head first without looking.  We rallied behind a vision to usher in a new era of transportation for a country that has grown accustomed to a reality that was due for replacement more than 50 years ago.  This was along with all of the pollution, discomfort and hidden costs (externalities, in economist speak) that comes with it.</p>

<p><img src="/assets/images/pedal-power/launch_day.jpg" alt="Launch day" /></p>

<p>In our first launch, people were delighted.  This was new, exciting and it improved quality of life in several ways beyond the quiet &amp; ‘smokelessness’ of the vehicles themselves.  We were hitting our target numbers and people were feeling pretty optimistic about where we might go next.</p>

<p>Contrary to the experience of many early-stage entrepreneurs, I cannot think of a single time that somebody told me that what we are trying to accomplish is impossible.  As foreigners operating in a developing economy, it tends to sound more like:</p>

<p><strong><em>If you can’t make it work, there’s no hope for the rest of us</em></strong></p>

<p>As I reflect on my life so far, my circumstances have been extrememly fortunate.  I have many talents and have always had plenty of access to opportunity.  The system works well for me.  So I work hard and generally I get good results.</p>

<p><img src="/assets/images/pedal-power/gilbert.jpg" alt="Gilbert" width="250" height="250" /></p>

<p>While the modern era likes to promote itself as a champion of equal opportunity, Filipinos have become well-adjusted to a life lived on the margin of that system.</p>

<p>Frankie’s roots were also much closer to the margin.  As much as he wanted to keep up with his friends (myself included) in their adventures, the cruel realities of his roots would show themselves.</p>

<p>So here I am again, in the middle to two worlds, to the left is the world that is keen to reward talent and usher in the future as fast as possible. To the right is a world full of people working hard just to keep their head above water and searching frantically for a lifeline.  As the waters rise, the number of frantic swimmers will be only increase.</p>

<p><img src="/assets/images/pedal-power/maria.jpg" alt="Maria" width="250" height="250" /></p>

<p>It is through knowing our history that we have the best chance of ensuring that this transition we are undertaking will produce a truly better future. I won’t pretend that I know the solution but I am as committed as ever to keep fighting to make this solution work, whatever it takes.</p>

<p>Captain Piccard is dreaming that humanity will rise to a new level, will trust the winds (and the weathermen) to take us out of the challenges of today.  It is people like him that help me to keep my eyes on the horizon.  To watch for the silver lining.</p>

<p><img src="/assets/images/pedal-power/sunset.jpg" alt="Sunset" /></p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="solar-impulse" /><summary type="html"><![CDATA[In a salute to the 1000 solution milestone of the Solar Impulse Foundation, This story is a bit of an hommage to the immensely inspiring 2010 TED talk by Captain Bertrand Piccard titled ‘My Solar-Powered Adventure’.]]></summary></entry><entry><title type="html">SE Asia’s Labelled Solutions for water cleanup.</title><link href="https://sunetrike.com/solar-impulse/se-asias-water-cleanup-solutions/" rel="alternate" type="text/html" title="SE Asia’s Labelled Solutions for water cleanup." /><published>2021-04-12T01:08:07+08:00</published><updated>2021-04-12T01:08:07+08:00</updated><id>https://sunetrike.com/solar-impulse/se-asias-water-cleanup-solutions</id><content type="html" xml:base="https://sunetrike.com/solar-impulse/se-asias-water-cleanup-solutions/"><![CDATA[<p>Here we are, one thousand solutions closer to a cleaner planet.  With the <a href="https://solarimpulse.com/beyond-1000-solutions">#beyond1000solutions</a> campaign, Solar Impulse is gearing up to bring the forward the next wave of Cleantech into the world.</p>

<p>To get the ball rolling for the next phase, I’ve put together a short list of some of the solutions getting developed across SE Asia.</p>

<h2 id="the-broad-categories">The broad categories</h2>

<p>To date, SE Asia sits at 16 labelled solutions.  I’ve broken them down into 3 broad themes (I guess that makes me a lumper, not a splitter):</p>

<table>
  <tbody>
    <tr>
      <td><strong>Category</strong></td>
      <td><strong>Labelled Solutions</strong></td>
    </tr>
    <tr>
      <td>Cleaning up our water</td>
      <td>4</td>
    </tr>
    <tr>
      <td>Getting more efficient</td>
      <td>7</td>
    </tr>
    <tr>
      <td>Better, Cleaner Mobility</td>
      <td>5</td>
    </tr>
  </tbody>
</table>

<p>For sure, some will contest my very crude categorizations.  I’d encourage them to also write an article.</p>

<h2 id="by-country">By country</h2>
<p>By country, it’s probably no surprise to anyone that Singapore leads the pack:</p>

<table>
  <tbody>
    <tr>
      <td><strong>Name</strong></td>
      <td><strong>Labelled Solutions</strong></td>
    </tr>
    <tr>
      <td>Singapore</td>
      <td>11</td>
    </tr>
    <tr>
      <td>Hong Kong</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Philippines</td>
      <td>1</td>
    </tr>
    <tr>
      <td>South Korea</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Taiwan</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Thailand</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<p>Given the obvious bias that would come along with me trying to pick favourites within a group that our company is active in, I’m only going to talk about my picks from Category 1 &amp; 2.  This article is going to be about water.</p>

<h2 id="disclaimer">Disclaimer</h2>
<p>I would consider myself as a capable student of pollution solutions in general.  However, I claim no expertise or specialized knowledge in any of the technologies mentioned below.  I have not reviewed any information beyond what has been made publicy available on Solar Impulse and their own webpage.</p>

<h1 id="cleaning-up-our-water">Cleaning up our water</h1>

<p>There’s no question that global water resources are deteriorating.  This decline comes from various factors including:</p>
<ul>
  <li>direct chemical pollution</li>
  <li>micro-plastics overtaking fish</li>
  <li>fertilizer and erosion runoff killing the world’s coastal ecosystems.</li>
</ul>

<p>We desperately need to improve our track record on hydro-externalities.  The 3 solutions below each endeavour to accomplish that.</p>

<h2 id="1-ecoworth">1. <a href="http://ecoworth-tech.com/">EcoWorth</a></h2>
<h3 id="solar-impulse-page"><a href="https://solarimpulse.com/efficient-solutions/carbon-fibre-aerogel-cfa">Solar Impulse Page</a></h3>

<p>EcoWorth is targeting organics in wastewater.  Organics are a broad category which include most of the contaminants causing bad smells in most of the region’s urban lakes and waterways.</p>

<p>In the case of this technology, however, the ‘valuable organics’ that they are targeting appear to be some fom of spilled oil.</p>

<p>You may find the video a little hard to understand, but take note of the oily, yellow film on top of the water.  Absorbent pillows like these are often used in oil spills on the ocean.</p>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/0_ctmxYjVgI" loading="lazy" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p>Because of the many pipelines and other oil-producing facilities across the world, these kinds of absorbent materials definitely have widespread demand.</p>

<p>The term for a material that strongly repels water is <em><strong>‘Cat’</strong></em>.  Just kidding, it’s considered a ‘hydrophobic’ material and there are some great video demonstrations like this one out there in the cloud</p>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/Ls_ISb7lG-I" loading="lazy" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<h2 id="2-electro-contaminant-removal-system">2. <a href="http://www.tridentwater.com.sg/">Electro-contaminant removal system</a></h2>
<h3 id="solar-impulse-page-1"><a href="https://solarimpulse.com/efficient-solutions/electro-contaminant-removal-ecr-system">Solar Impulse Page</a></h3>

<p>ECR targets contaminated wastewater by applying electric fields which cause dissolved contaminants to lump together or coagulate (like your blood, when you get cut).  Today, this process is often done using chemicals called floculants.</p>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/yFlrfZK8ErU" loading="lazy" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p>Avoiding chemical usage with this approach, is certainly attractive and I look forward to seeing more.
They are targetting phosphorus, even 10 years ago, concerns were being raised about phosphorus shortages in the coming decades.  Now that phosphorus has become a popular battery material, recovering the material from wastewater should be a high priority going forward.</p>

<h2 id="3-plakman">3. PlakMan</h2>
<h3 id="solar-impulse-page-2"><a href="https://solarimpulse.com/efficient-solutions/plakman">Solar Impulse Page</a></h3>

<p>Ocean Plastics is a sector where the <a href="https://www.researchgate.net/figure/waste-hierarchy-8-Eventually-the-higher-concepts-of-waste-management-such-as-3R-and_fig1_303369997">Cleaner Production Pyramid</a> plays a hugely important role.  The shear volume of plastics entering oceans every day is difficult to fathom.  To really make a dent on this issue will require solutions at every level of the pyramid.</p>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/19x7ur_vCv0" loading="lazy" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p>Given that collection/recovery, sits so low on the pyramid, they will probably be categorized as among the most expensive solutions. But that doesn’t mean it’s not necessary.  When PlakMan’s boats hit the water to start sucking up plastic, I hope careful thought will be  given to the location of their initial deployments.</p>

<p>With all that said, I’m very happy to see new groups coming in to join the effort.  Humanity has had quite the party since first discovering plastics.  The cleanup job is substantial and many hands make lighter work.</p>

<h1 id="wrap-up">Wrap up</h1>

<p>Hopefully, some of my thoughts above have been helpful in looking at where we might go with these solutions.</p>

<p>Since you’re here, feel free to look around and learn more about our own solution.  You can check out our <a href="https://solarimpulse.com/efficient-solutions/sune">Solar Impulse profile</a>.</p>

<p>I’m very excited to see these projects continue to build steam as we move <a href="https://solarimpulse.com/beyond-1000-solutions">#beyond1000solutions</a>.</p>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="solar-impulse" /><summary type="html"><![CDATA[Here we are, one thousand solutions closer to a cleaner planet. With the #beyond1000solutions campaign, Solar Impulse is gearing up to bring the forward the next wave of Cleantech into the world.]]></summary></entry><entry><title type="html">My First Lung Fractal</title><link href="https://sunetrike.com/fractals/lungs/dr-geo/first-lung-fractal/" rel="alternate" type="text/html" title="My First Lung Fractal" /><published>2021-01-14T01:08:07+08:00</published><updated>2021-01-14T01:08:07+08:00</updated><id>https://sunetrike.com/fractals/lungs/dr-geo/first-lung-fractal</id><content type="html" xml:base="https://sunetrike.com/fractals/lungs/dr-geo/first-lung-fractal/"><![CDATA[<p>Since I first moved to the Philippines, the air pollution has been one of the hardest features to come to grips with.</p>

<p>I seem to have especially sensitive lungs as I come down with lung infections 2 to 3 times a year and it lingers for several weeks meanwhile nobody around me ever seems to get sick.</p>

<p>But enough about that, the coronavirus has given people all sorts of reasons to pay more attention to their lungs in 2020 and 2021.</p>

<p>I also have a thing for fractals and lungs are one of the famous examples of fractals that make an impact on our everyday life. <a href="https://www.atsjournals.org/doi/full/10.1164/rccm.200308-1107OC">One study estimated a whopping 480 million alveoli</a> in the lungs of an average adult.</p>

<p>At a diametre of 0.2mm across, you need 8 of them to provide 1mm^2 of oxygen:blood interface.  This gives me a total surface are of 60m^2.  While <a href="https://www.reference.com/science/surface-area-human-lungs-ffc6ae1756c2f2e">other</a> <a href="https://www.bbc.co.uk/bitesize/guides/zwyfxfr/revision/4">internet</a> <a href="https://en.wikipedia.org/wiki/Pulmonary_alveolus">sources</a> yield 50 to 100 m^2; about the size of a tennis court.</p>

<p>To hit those kinds of numbers from a structure that bifurcates (branches or splits into 2), you need 29 levels of branching.  <a href="https://www.sciencedirect.com/science/article/pii/S1474667016387791">Meanwhile, this study models branching down to 23 levels</a>.  My computer starts to seriously slow down around 12.  Poor little bugger!</p>

<p>I recently discovered <a href="https://www.gnu.org/software/dr-geo/">Dr Geo</a>, a pretty cool open-source geometry drawing program with a Smalltalk interface.  This is totally new territory for me but I was able to get a branching fractal to make a crude approximation of a lung structure.</p>

<p>Give it a shot, windows users will probably need to use <a href="https://ubuntu.com/tutorials/ubuntu-on-windows#1-overview">Ubuntu in Windows</a>:</p>

<figure class="highlight"><pre><code class="language-smalltalk" data-lang="smalltalk"><span class="p">|</span><span class="nv"> figure angle alpha beta strand centre edge </span><span class="p">|</span>
<span class="nv">figure</span> <span class="o">:=</span> <span class="nc">DrGeoFigure</span> <span class="nb">new</span><span class="p">.</span>
<span class="nv">angle</span> <span class="o">:=</span> <span class="m">30</span><span class="p">.</span>
<span class="nv">alpha</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">freeValue:</span> <span class="nv">angle</span> <span class="nf">degreesToRadians</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span>
<span class="nv">beta</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">freeValue:</span> <span class="p">(</span><span class="m">360</span> <span class="nf">-</span> <span class="nv">angle</span><span class="p">)</span> <span class="nf">degreesToRadians</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span>
<span class="nv">centre</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">point:</span> <span class="m">0</span><span class="nf">@</span><span class="m">6</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span>
<span class="nv">edge</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">point:</span> <span class="m">0</span><span class="nf">@</span><span class="m">0</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span>

<span class="nv">strand</span> <span class="o">:=</span> <span class="p">[</span>  <span class="o">:</span><span class="nv">s1</span> <span class="o">:</span><span class="nv">s2</span> <span class="o">:</span><span class="nv">n</span> <span class="p">|</span> <span class="p">|</span><span class="nv"> p1 p2 p3  seg </span><span class="p">|</span>
	<span class="nv">p1</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">middleOf:</span> <span class="nv">s1</span> <span class="nf">and:</span> <span class="nv">s2</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span>
	<span class="nv">p2</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">rotate:</span> <span class="nv">s2</span> <span class="nf">center:</span> <span class="nv">s1</span>  <span class="nf">angle:</span> <span class="nv">alpha</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span> 
	<span class="nv">p3</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">rotate:</span> <span class="nv">s2</span> <span class="nf">center:</span> <span class="nv">s1</span>  <span class="nf">angle:</span> <span class="nv">beta</span><span class="p">)</span> <span class="nf">hide</span><span class="p">.</span> 
	<span class="nv">seg</span> <span class="o">:=</span> <span class="p">(</span><span class="nv">figure</span> <span class="nf">segment:</span> <span class="nv">s1</span> <span class="nf">to:</span> <span class="nv">p1</span><span class="p">)</span> <span class="p">.</span>
	<span class="nv">n</span> <span class="nf">&gt;</span><span class="m">6</span> <span class="nb">ifTrue:</span> 
		<span class="p">[</span> 
			<span class="nv">seg</span> <span class="nf">large</span><span class="p">.</span> 
		<span class="p">].</span>
	<span class="nv">n</span> <span class="nf">&gt;</span><span class="m">0</span> <span class="nb">ifTrue:</span>
		<span class="p">[</span> 
			<span class="nv">strand</span>
				<span class="nf">value:</span> <span class="nv">p1</span>
				<span class="nf">value:</span> <span class="nv">p2</span>
				<span class="nf">value:</span> <span class="nv">n</span> <span class="nf">-</span> <span class="m">1</span><span class="p">.</span>
			<span class="nv">strand</span>
				<span class="nf">value:</span> <span class="nv">p1</span>
				<span class="nf">value:</span> <span class="nv">p3</span>
				<span class="nf">value:</span> <span class="nv">n</span> <span class="nf">-</span> <span class="m">1</span><span class="p">.</span>
		<span class="p">].</span>
	<span class="nv">n</span><span class="nf">=</span><span class="m">0</span> <span class="nb">ifTrue:</span>
		<span class="p">[</span> 
			<span class="nv">figure</span> <span class="nf">segment:</span> <span class="nv">p1</span> <span class="nf">to:</span> <span class="nv">p2</span><span class="p">.</span> 
			<span class="nv">figure</span> <span class="nf">segment:</span> <span class="nv">p1</span> <span class="nf">to:</span> <span class="nv">p3</span><span class="p">.</span>
		 <span class="p">].</span>
<span class="p">].</span>

<span class="nf">strand</span>
	<span class="nf">value:</span> <span class="nv">centre</span>
	<span class="nf">value:</span> <span class="nv">edge</span>
	<span class="nf">value:</span> <span class="nv">10</span><span class="err">.</span></code></pre></figure>

<div class="newsletter_wrapper">
  <h3>Interested in hearing more from us? <a href="/newsletter/"> Check out our newsletter</a></h3>
</div>]]></content><author><name>Allan Gray</name></author><category term="fractals" /><category term="lungs" /><category term="dr-geo" /><summary type="html"><![CDATA[Since I first moved to the Philippines, the air pollution has been one of the hardest features to come to grips with.]]></summary></entry></feed>